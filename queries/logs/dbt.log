[0m22:07:18.163857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7c84e8f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7c5162b90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7c5162f90>]}


============================== 22:07:18.169959 | 74d03929-f5ea-4480-9bc7-652130f17434 ==============================
[0m22:07:18.169959 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:07:18.170601 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/root/.dbt', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:07:18.192207 [info ] [MainThread]: dbt version: 1.9.4
[0m22:07:18.192803 [info ] [MainThread]: python version: 3.11.2
[0m22:07:18.193221 [info ] [MainThread]: python path: /root/venv-abordagem/bin/python3.11
[0m22:07:18.193590 [info ] [MainThread]: os info: Linux-6.1.0-34-amd64-x86_64-with-glibc2.36
[0m22:07:22.942457 [info ] [MainThread]: Using profiles dir at /root/.dbt
[0m22:07:22.943004 [info ] [MainThread]: Using profiles.yml file at /root/.dbt/profiles.yml
[0m22:07:22.943313 [info ] [MainThread]: Using dbt_project.yml file at /root/pipelines/arcgis/abordagem/queries/dbt_project.yml
[0m22:07:22.943611 [info ] [MainThread]: adapter type: bigquery
[0m22:07:22.943896 [info ] [MainThread]: adapter version: 1.9.2
[0m22:07:23.063952 [info ] [MainThread]: Configuration:
[0m22:07:23.064603 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m22:07:23.065014 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m22:07:23.065460 [info ] [MainThread]: Required dependencies:
[0m22:07:23.065880 [debug] [MainThread]: Executing "git --help"
[0m22:07:23.068589 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m22:07:23.069175 [debug] [MainThread]: STDERR: "b''"
[0m22:07:23.069615 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m22:07:23.070011 [info ] [MainThread]: Connection:
[0m22:07:23.079604 [info ] [MainThread]:   method: service-account
[0m22:07:23.080055 [info ] [MainThread]:   database: rj-smas-dev
[0m22:07:23.080539 [info ] [MainThread]:   execution_project: rj-smas-dev
[0m22:07:23.080971 [info ] [MainThread]:   schema: dashboard_arcgis
[0m22:07:23.081379 [info ] [MainThread]:   location: US
[0m22:07:23.081735 [info ] [MainThread]:   priority: None
[0m22:07:23.082024 [info ] [MainThread]:   maximum_bytes_billed: None
[0m22:07:23.082338 [info ] [MainThread]:   impersonate_service_account: None
[0m22:07:23.082627 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m22:07:23.082942 [info ] [MainThread]:   job_retries: 1
[0m22:07:23.083231 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m22:07:23.083513 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m22:07:23.083793 [info ] [MainThread]:   timeout_seconds: 300
[0m22:07:23.084073 [info ] [MainThread]:   client_id: None
[0m22:07:23.084350 [info ] [MainThread]:   token_uri: None
[0m22:07:23.084626 [info ] [MainThread]:   compute_region: None
[0m22:07:23.084909 [info ] [MainThread]:   dataproc_cluster_name: None
[0m22:07:23.085182 [info ] [MainThread]:   gcs_bucket: None
[0m22:07:23.085494 [info ] [MainThread]:   dataproc_batch: None
[0m22:07:23.085966 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:07:23.260886 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m22:07:23.261348 [debug] [MainThread]: On debug: select 1 as id
[0m22:07:23.261669 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:07:24.523625 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:d8e3e45a-d4cf-4859-b6f4-2d0751c6db25&page=queryresults
[0m22:07:25.164587 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m22:07:25.165326 [info ] [MainThread]: [32mAll checks passed![0m
[0m22:07:25.166243 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 7.0698524, "process_in_blocks": "363664", "process_kernel_time": 1.546162, "process_mem_max_rss": "413580", "process_out_blocks": "24", "process_user_time": 4.444723}
[0m22:07:25.167047 [debug] [MainThread]: Command `dbt debug` succeeded at 22:07:25.166853 after 7.07 seconds
[0m22:07:25.167628 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m22:07:25.168258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7c9525350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7a5d68090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7c53b5a50>]}
[0m22:07:25.168743 [debug] [MainThread]: Flushing usage events
[0m22:07:25.729666 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:07:40.496923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4d1ae2d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4d1d5d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4d1d5b10>]}


============================== 22:07:40.499921 | b26fa56e-cf81-467e-8b47-a361d3ef7686 ==============================
[0m22:07:40.499921 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:07:40.500762 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'debug': 'False', 'profiles_dir': '/root/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:07:43.470409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2df7f310>]}
[0m22:07:43.546601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4fb5fe50>]}
[0m22:07:43.547471 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:07:43.727164 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:07:43.727935 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:07:43.728310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2dc58e10>]}
[0m22:07:45.464941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2db3a750>]}
[0m22:07:45.542829 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m22:07:45.545321 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m22:07:45.558659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2d2e8510>]}
[0m22:07:45.559399 [info ] [MainThread]: Found 1 model, 1 source, 493 macros
[0m22:07:45.559755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4fad2650>]}
[0m22:07:45.561339 [info ] [MainThread]: 
[0m22:07:45.561762 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:07:45.562111 [info ] [MainThread]: 
[0m22:07:45.562654 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:07:45.564120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m22:07:45.564812 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:07:46.216714 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m22:07:46.217373 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:07:46.792921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2d397850>]}
[0m22:07:46.793657 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:07:46.844585 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m22:07:46.845359 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m22:07:46.845944 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m22:07:46.846562 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m22:07:46.855332 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m22:07:46.856134 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m22:07:46.894162 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m22:07:46.895104 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m22:07:46.895599 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:07:47.719677 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:57c4439b-1285-4ef7-867e-b621aa68c708&page=queryresults
[0m22:07:51.267271 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26fa56e-cf81-467e-8b47-a361d3ef7686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec2d3f2e90>]}
[0m22:07:51.268000 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (177.6k rows, 29.8 MiB processed)[0m in 4.42s]
[0m22:07:51.268783 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m22:07:51.270156 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:07:51.312540 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:07:51.313083 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m22:07:51.313504 [info ] [MainThread]: 
[0m22:07:51.314130 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.75 seconds (5.75s).
[0m22:07:51.315288 [debug] [MainThread]: Command end result
[0m22:07:51.338288 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m22:07:51.340195 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m22:07:51.346216 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/abordagem/queries/target/run_results.json
[0m22:07:51.346669 [info ] [MainThread]: 
[0m22:07:51.347198 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:07:51.347599 [info ] [MainThread]: 
[0m22:07:51.347969 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:07:51.348719 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 10.924848, "process_in_blocks": "2840", "process_kernel_time": 1.162856, "process_mem_max_rss": "428464", "process_out_blocks": "3008", "process_user_time": 6.359165}
[0m22:07:51.349183 [debug] [MainThread]: Command `dbt run` succeeded at 22:07:51.349084 after 10.93 seconds
[0m22:07:51.349597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec51529350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec4d3f9890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fec515d6990>]}
[0m22:07:51.350031 [debug] [MainThread]: Flushing usage events
[0m22:07:51.876356 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:59:27.042485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f49b24062d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f49b21a8690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f49b21a8b50>]}


============================== 22:59:27.045449 | 09f8ce31-4653-4399-90b8-8d4079b412e7 ==============================
[0m22:59:27.045449 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:59:27.045962 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/root/.dbt', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:59:27.052588 [info ] [MainThread]: dbt version: 1.9.4
[0m22:59:27.053052 [info ] [MainThread]: python version: 3.11.2
[0m22:59:27.053376 [info ] [MainThread]: python path: /root/venv-abordagem/bin/python3.11
[0m22:59:27.053693 [info ] [MainThread]: os info: Linux-6.1.0-34-amd64-x86_64-with-glibc2.36
[0m22:59:29.998718 [info ] [MainThread]: Using profiles dir at /root/.dbt
[0m22:59:29.999481 [info ] [MainThread]: Using profiles.yml file at /root/.dbt/profiles.yml
[0m22:59:29.999877 [info ] [MainThread]: Using dbt_project.yml file at /root/pipelines/arcgis/abordagem/queries/dbt_project.yml
[0m22:59:30.000271 [info ] [MainThread]: adapter type: bigquery
[0m22:59:30.000634 [info ] [MainThread]: adapter version: 1.9.2
[0m22:59:30.124516 [info ] [MainThread]: Configuration:
[0m22:59:30.125078 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m22:59:30.125390 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m22:59:30.125683 [info ] [MainThread]: Required dependencies:
[0m22:59:30.126024 [debug] [MainThread]: Executing "git --help"
[0m22:59:30.128565 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m22:59:30.129514 [debug] [MainThread]: STDERR: "b''"
[0m22:59:30.129869 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m22:59:30.130220 [info ] [MainThread]: Connection:
[0m22:59:30.130598 [info ] [MainThread]:   method: service-account
[0m22:59:30.130935 [info ] [MainThread]:   database: rj-smas-dev
[0m22:59:30.131230 [info ] [MainThread]:   execution_project: rj-smas-dev
[0m22:59:30.131512 [info ] [MainThread]:   schema: dashboard_arcgis
[0m22:59:30.131789 [info ] [MainThread]:   location: US
[0m22:59:30.132135 [info ] [MainThread]:   priority: None
[0m22:59:30.132514 [info ] [MainThread]:   maximum_bytes_billed: None
[0m22:59:30.132798 [info ] [MainThread]:   impersonate_service_account: None
[0m22:59:30.133073 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m22:59:30.133358 [info ] [MainThread]:   job_retries: 1
[0m22:59:30.133658 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m22:59:30.133962 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m22:59:30.134321 [info ] [MainThread]:   timeout_seconds: 300
[0m22:59:30.134697 [info ] [MainThread]:   client_id: None
[0m22:59:30.135010 [info ] [MainThread]:   token_uri: None
[0m22:59:30.135293 [info ] [MainThread]:   compute_region: None
[0m22:59:30.135599 [info ] [MainThread]:   dataproc_cluster_name: None
[0m22:59:30.135872 [info ] [MainThread]:   gcs_bucket: None
[0m22:59:30.136142 [info ] [MainThread]:   dataproc_batch: None
[0m22:59:30.136639 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:59:30.309509 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m22:59:30.310034 [debug] [MainThread]: On debug: select 1 as id
[0m22:59:30.310383 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:59:31.107709 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:ed51193c-6340-4c30-850f-a6ff3d3e9724&page=queryresults
[0m22:59:31.692591 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m22:59:31.693184 [info ] [MainThread]: [32mAll checks passed![0m
[0m22:59:31.693910 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 4.714856, "process_in_blocks": "56", "process_kernel_time": 1.05036, "process_mem_max_rss": "413980", "process_out_blocks": "24", "process_user_time": 4.568535}
[0m22:59:31.694661 [debug] [MainThread]: Command `dbt debug` succeeded at 22:59:31.694513 after 4.72 seconds
[0m22:59:31.695108 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m22:59:31.695522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f49b65e5310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4992fe2f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4992dd4850>]}
[0m22:59:31.696052 [debug] [MainThread]: Flushing usage events
[0m22:59:32.291847 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:00:06.908148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9154103450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f91540ebfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f91540a2190>]}


============================== 23:00:06.911226 | 25ad09e8-e332-48fd-b5dc-b6e10c5ae650 ==============================
[0m23:00:06.911226 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:00:06.911847 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/root/.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:00:09.964459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9134fe1250>]}
[0m23:00:10.080039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9156a18490>]}
[0m23:00:10.081206 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:00:10.263721 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:00:10.362488 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m23:00:10.363148 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/abordagem_repeat.sql
[0m23:00:10.363699 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/schema.yml
[0m23:00:11.102712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9134747c90>]}
[0m23:00:11.178469 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m23:00:11.180495 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m23:00:11.191922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9133dd23d0>]}
[0m23:00:11.192486 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m23:00:11.192853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9133f02c10>]}
[0m23:00:11.194493 [info ] [MainThread]: 
[0m23:00:11.194925 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:00:11.195289 [info ] [MainThread]: 
[0m23:00:11.195821 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:00:11.200331 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m23:00:11.201042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:11.957616 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m23:00:11.958340 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:12.693081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9133ecaad0>]}
[0m23:00:12.693921 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:00:12.750131 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m23:00:12.750697 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m23:00:12.751473 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m23:00:12.752116 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis.abordagem_repeat ................. [RUN]
[0m23:00:12.752795 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m23:00:12.753340 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m23:00:12.753762 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m23:00:12.754244 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m23:00:12.762488 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m23:00:12.768776 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m23:00:12.769761 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m23:00:12.775515 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m23:00:12.785129 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:00:12.877332 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m23:00:12.878765 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(PARSE_TIMESTAMP('%Y-%m-%d %H:%M:%E6S', data_abordagem)) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  IFNULL(aceita_acolhimento, 'N/A') AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m23:00:12.879785 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m23:00:13.500739 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m23:00:13.501915 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m23:00:13.764113 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:8d6dc997-5161-4b3a-a8fb-4548909b8b74&page=queryresults
[0m23:00:14.016405 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:8d6dc997-5161-4b3a-a8fb-4548909b8b74&page=queryresults
[0m23:00:14.028090 [debug] [Thread-2 (]: Database Error in model abordagem_repeat (models/dashboard_arcgis/abordagem_repeat.sql)
  No matching signature for function PARSE_TIMESTAMP
    Argument types: STRING, TIMESTAMP
    Signature: PARSE_TIMESTAMP(STRING, STRING, [STRING])
      Argument 2: Unable to coerce type TIMESTAMP to expected type STRING at [69:8]
  compiled code at target/run/queries/models/dashboard_arcgis/abordagem_repeat.sql
[0m23:00:14.029818 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9133c79610>]}
[0m23:00:14.030572 [error] [Thread-2 (]: 2 of 2 ERROR creating sql table model dashboard_arcgis.abordagem_repeat ........ [[31mERROR[0m in 1.28s]
[0m23:00:14.031160 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m23:00:14.032323 [debug] [Thread-5 (]: Marking all children of 'model.queries.abordagem_repeat' to be skipped because of status 'error'.  Reason: Database Error in model abordagem_repeat (models/dashboard_arcgis/abordagem_repeat.sql)
  No matching signature for function PARSE_TIMESTAMP
    Argument types: STRING, TIMESTAMP
    Signature: PARSE_TIMESTAMP(STRING, STRING, [STRING])
      Argument 2: Unable to coerce type TIMESTAMP to expected type STRING at [69:8]
  compiled code at target/run/queries/models/dashboard_arcgis/abordagem_repeat.sql.
[0m23:00:14.047795 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:2fdd346b-84d3-402a-bacf-e2ad18ab7e42&page=queryresults
[0m23:00:18.906446 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '25ad09e8-e332-48fd-b5dc-b6e10c5ae650', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9131095550>]}
[0m23:00:18.907334 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (177.6k rows, 29.8 MiB processed)[0m in 6.15s]
[0m23:00:18.908268 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m23:00:18.910279 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:00:18.955151 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:18.955644 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m23:00:18.955944 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m23:00:18.956369 [info ] [MainThread]: 
[0m23:00:18.956732 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 7.76 seconds (7.76s).
[0m23:00:18.957715 [debug] [MainThread]: Command end result
[0m23:00:18.977909 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m23:00:18.979627 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m23:00:18.985163 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/abordagem/queries/target/run_results.json
[0m23:00:18.985519 [info ] [MainThread]: 
[0m23:00:18.985882 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m23:00:18.986277 [info ] [MainThread]: 
[0m23:00:18.986753 [error] [MainThread]:   Database Error in model abordagem_repeat (models/dashboard_arcgis/abordagem_repeat.sql)
  No matching signature for function PARSE_TIMESTAMP
    Argument types: STRING, TIMESTAMP
    Signature: PARSE_TIMESTAMP(STRING, STRING, [STRING])
      Argument 2: Unable to coerce type TIMESTAMP to expected type STRING at [69:8]
  compiled code at target/run/queries/models/dashboard_arcgis/abordagem_repeat.sql
[0m23:00:18.987173 [info ] [MainThread]: 
[0m23:00:18.987506 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m23:00:18.988091 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 12.153972, "process_in_blocks": "448", "process_kernel_time": 1.095521, "process_mem_max_rss": "430388", "process_out_blocks": "3296", "process_user_time": 5.897403}
[0m23:00:18.988556 [debug] [MainThread]: Command `dbt run` failed at 23:00:18.988465 after 12.15 seconds
[0m23:00:18.989126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9158425310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9154103790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f915410c890>]}
[0m23:00:18.989497 [debug] [MainThread]: Flushing usage events
[0m23:00:19.528825 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:03:00.121490 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d83462990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d834d2ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d8346c0d0>]}


============================== 23:03:00.124601 | e1f44007-2f4f-454c-9a47-7652647f3d0f ==============================
[0m23:03:00.124601 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:03:00.125149 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'version_check': 'True', 'profiles_dir': '/root/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt debug', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:03:00.131915 [info ] [MainThread]: dbt version: 1.9.4
[0m23:03:00.132430 [info ] [MainThread]: python version: 3.11.2
[0m23:03:00.132755 [info ] [MainThread]: python path: /root/venv-abordagem/bin/python3.11
[0m23:03:00.133047 [info ] [MainThread]: os info: Linux-6.1.0-34-amd64-x86_64-with-glibc2.36
[0m23:03:03.186515 [info ] [MainThread]: Using profiles dir at /root/.dbt
[0m23:03:03.187326 [info ] [MainThread]: Using profiles.yml file at /root/.dbt/profiles.yml
[0m23:03:03.187771 [info ] [MainThread]: Using dbt_project.yml file at /root/pipelines/arcgis/abordagem/queries/dbt_project.yml
[0m23:03:03.188137 [info ] [MainThread]: adapter type: bigquery
[0m23:03:03.188545 [info ] [MainThread]: adapter version: 1.9.2
[0m23:03:03.335367 [info ] [MainThread]: Configuration:
[0m23:03:03.335977 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m23:03:03.336297 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m23:03:03.336586 [info ] [MainThread]: Required dependencies:
[0m23:03:03.336897 [debug] [MainThread]: Executing "git --help"
[0m23:03:03.338966 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m23:03:03.339717 [debug] [MainThread]: STDERR: "b''"
[0m23:03:03.340045 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m23:03:03.340489 [info ] [MainThread]: Connection:
[0m23:03:03.340955 [info ] [MainThread]:   method: service-account
[0m23:03:03.341315 [info ] [MainThread]:   database: rj-smas-dev
[0m23:03:03.341728 [info ] [MainThread]:   execution_project: rj-smas-dev
[0m23:03:03.342038 [info ] [MainThread]:   schema: dashboard_arcgis
[0m23:03:03.342461 [info ] [MainThread]:   location: US
[0m23:03:03.342757 [info ] [MainThread]:   priority: None
[0m23:03:03.343169 [info ] [MainThread]:   maximum_bytes_billed: None
[0m23:03:03.343492 [info ] [MainThread]:   impersonate_service_account: None
[0m23:03:03.343867 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m23:03:03.344154 [info ] [MainThread]:   job_retries: 1
[0m23:03:03.344427 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m23:03:03.344700 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m23:03:03.344971 [info ] [MainThread]:   timeout_seconds: 300
[0m23:03:03.345247 [info ] [MainThread]:   client_id: None
[0m23:03:03.345651 [info ] [MainThread]:   token_uri: None
[0m23:03:03.346058 [info ] [MainThread]:   compute_region: None
[0m23:03:03.346374 [info ] [MainThread]:   dataproc_cluster_name: None
[0m23:03:03.346760 [info ] [MainThread]:   gcs_bucket: None
[0m23:03:03.347099 [info ] [MainThread]:   dataproc_batch: None
[0m23:03:03.347709 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:03:03.518257 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m23:03:03.518789 [debug] [MainThread]: On debug: select 1 as id
[0m23:03:03.519140 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:03:04.283549 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:3e6e1397-9198-44cc-9bcc-9da6d7b22ba1&page=queryresults
[0m23:03:04.888116 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m23:03:04.889142 [info ] [MainThread]: [32mAll checks passed![0m
[0m23:03:04.889950 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 4.842009, "process_in_blocks": "0", "process_kernel_time": 1.117642, "process_mem_max_rss": "414136", "process_out_blocks": "24", "process_user_time": 4.585279}
[0m23:03:04.890461 [debug] [MainThread]: Command `dbt debug` succeeded at 23:03:04.890360 after 4.84 seconds
[0m23:03:04.890841 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m23:03:04.891245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d877e5310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d85905950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4d859887d0>]}
[0m23:03:04.891642 [debug] [MainThread]: Flushing usage events
[0m23:03:05.460094 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:03:13.432046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bb7efa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bb7ef810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bb7ef7d0>]}


============================== 23:03:13.434841 | 2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0 ==============================
[0m23:03:13.434841 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:03:13.435370 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/root/.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/root/pipelines/arcgis/abordagem/queries/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:03:16.407062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bd3a8290>]}
[0m23:03:16.483234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7be1d74d0>]}
[0m23:03:16.484103 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:03:16.649947 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:03:16.761130 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:03:16.761854 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/abordagem_repeat.sql
[0m23:03:17.322611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa79c0e6290>]}
[0m23:03:17.392309 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m23:03:17.394003 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m23:03:17.404260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa79b7f3290>]}
[0m23:03:17.404840 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m23:03:17.405189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa79bf35e10>]}
[0m23:03:17.406818 [info ] [MainThread]: 
[0m23:03:17.407197 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:03:17.407493 [info ] [MainThread]: 
[0m23:03:17.407985 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:03:17.412133 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m23:03:17.413112 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:03:18.087005 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m23:03:18.087724 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:03:18.688920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bb7debd0>]}
[0m23:03:18.689667 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:03:18.735773 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m23:03:18.737026 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m23:03:18.737943 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m23:03:18.738947 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis.abordagem_repeat ................. [RUN]
[0m23:03:18.739791 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m23:03:18.740749 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m23:03:18.741361 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m23:03:18.741933 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m23:03:18.753339 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m23:03:18.759059 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m23:03:18.760512 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m23:03:18.761235 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m23:03:18.800985 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:03:18.828393 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m23:03:18.899644 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  IFNULL(aceita_acolhimento, 'N/A') AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m23:03:18.901003 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m23:03:19.548488 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m23:03:19.549353 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m23:03:19.815913 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:10ee03f8-a5f2-4fe2-8976-7b3235815ce4&page=queryresults
[0m23:03:20.051641 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:2ebbc8d6-db11-4f87-89f3-e7c86f1f82d3&page=queryresults
[0m23:03:24.660460 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa79b86f910>]}
[0m23:03:24.661317 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (177.6k rows, 29.8 MiB processed)[0m in 5.92s]
[0m23:03:24.661911 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m23:03:29.673452 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e1b13b9-8ea3-484d-802f-a4f8bb2ed5a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa798c4f450>]}
[0m23:03:29.674235 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis.abordagem_repeat ............ [[32mCREATE TABLE (252.3k rows, 289.6 MiB processed)[0m in 10.93s]
[0m23:03:29.675098 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m23:03:29.676634 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:03:29.718227 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:03:29.718705 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m23:03:29.719055 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m23:03:29.719450 [info ] [MainThread]: 
[0m23:03:29.719819 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 12.31 seconds (12.31s).
[0m23:03:29.720662 [debug] [MainThread]: Command end result
[0m23:03:29.739806 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/abordagem/queries/target/manifest.json
[0m23:03:29.741421 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/abordagem/queries/target/semantic_manifest.json
[0m23:03:29.747069 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/abordagem/queries/target/run_results.json
[0m23:03:29.747495 [info ] [MainThread]: 
[0m23:03:29.747902 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:03:29.748224 [info ] [MainThread]: 
[0m23:03:29.748591 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m23:03:29.749154 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 16.383108, "process_in_blocks": "512", "process_kernel_time": 1.056629, "process_mem_max_rss": "425184", "process_out_blocks": "3288", "process_user_time": 5.686494}
[0m23:03:29.749614 [debug] [MainThread]: Command `dbt run` succeeded at 23:03:29.749515 after 16.38 seconds
[0m23:03:29.750000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bfbc5310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bb823310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa7bbaafe90>]}
[0m23:03:29.750373 [debug] [MainThread]: Flushing usage events
[0m23:03:30.284831 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:33:16.891001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb416167b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb4161d20d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb416172390>]}


============================== 23:33:16.895589 | f3dac3bd-c178-449c-9f2e-eb807a018dbc ==============================
[0m23:33:16.895589 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:33:16.896096 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/root/.dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/root/pipelines/arcgis/queries/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir /root/pipelines/arcgis/queries', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:33:21.805009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb3f6ebe550>]}
[0m23:33:21.874060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb418afedd0>]}
[0m23:33:21.874844 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:33:22.050175 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m23:33:22.251172 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:33:22.251691 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:33:22.500082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb3f6a93ad0>]}
[0m23:33:22.579372 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:33:22.582652 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:33:22.606194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb3f6fb1290>]}
[0m23:33:22.606760 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m23:33:22.607188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb416f4d4d0>]}
[0m23:33:22.608750 [info ] [MainThread]: 
[0m23:33:22.609139 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:33:22.609463 [info ] [MainThread]: 
[0m23:33:22.609993 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:33:22.614626 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m23:33:22.615318 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:33:23.436943 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m23:33:23.437740 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:33:23.992525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb416197050>]}
[0m23:33:23.993256 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:33:24.044747 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m23:33:24.045464 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m23:33:24.046253 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m23:33:24.046988 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis.abordagem_repeat ................. [RUN]
[0m23:33:24.047652 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m23:33:24.048245 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m23:33:24.048737 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m23:33:24.049317 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m23:33:24.060692 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m23:33:24.067084 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m23:33:24.068918 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m23:33:24.069531 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m23:33:24.084520 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m23:33:24.087958 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:24.811720 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m23:33:24.814579 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  IFNULL(aceita_acolhimento, 'N/A') AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m23:33:24.824307 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m23:33:24.825279 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m23:33:25.331773 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:a331d36d-138c-4885-b391-cdae68f86f85&page=queryresults
[0m23:33:25.351703 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:53e2b7dd-724b-4003-8739-1f179fad7753&page=queryresults
[0m23:33:29.205003 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb3f6a350d0>]}
[0m23:33:29.205770 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (177.7k rows, 29.8 MiB processed)[0m in 5.16s]
[0m23:33:29.206433 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m23:33:34.133981 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3dac3bd-c178-449c-9f2e-eb807a018dbc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb3f6e15250>]}
[0m23:33:34.134804 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis.abordagem_repeat ............ [[32mCREATE TABLE (252.4k rows, 289.7 MiB processed)[0m in 10.09s]
[0m23:33:34.135481 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m23:33:34.137493 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:33:34.181344 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:33:34.181841 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m23:33:34.182141 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m23:33:34.182681 [info ] [MainThread]: 
[0m23:33:34.183143 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.57 seconds (11.57s).
[0m23:33:34.183979 [debug] [MainThread]: Command end result
[0m23:33:34.204158 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:33:34.205976 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:33:34.212235 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/queries/target/run_results.json
[0m23:33:34.212592 [info ] [MainThread]: 
[0m23:33:34.213014 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:33:34.213385 [info ] [MainThread]: 
[0m23:33:34.213757 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m23:33:34.214350 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 17.38733, "process_in_blocks": "380008", "process_kernel_time": 1.224896, "process_mem_max_rss": "420260", "process_out_blocks": "2280", "process_user_time": 5.27123}
[0m23:33:34.214798 [debug] [MainThread]: Command `dbt run` succeeded at 23:33:34.214705 after 17.39 seconds
[0m23:33:34.215189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb4161dc350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb4161dfd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb41a5d6b90>]}
[0m23:33:34.215584 [debug] [MainThread]: Flushing usage events
[0m23:33:34.818722 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:49:57.599081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb52c3c2b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb52c5aa410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb52c492210>]}


============================== 14:49:57.614128 | 12743954-6c4f-467a-9552-608f7e9c392e ==============================
[0m14:49:57.614128 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:49:57.615140 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/root/.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/root/pipelines/arcgis/queries/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --project-dir /root/pipelines/arcgis/queries', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:50:01.773230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb52c3a6250>]}
[0m14:50:01.864500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50ce1e0d0>]}
[0m14:50:01.865469 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:50:02.059573 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:50:02.222074 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:50:02.222662 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:50:02.484505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50cc9ebd0>]}
[0m14:50:02.563776 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m14:50:02.565721 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m14:50:02.593706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50d0bf6d0>]}
[0m14:50:02.594349 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m14:50:02.594814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50cfc95d0>]}
[0m14:50:02.596769 [info ] [MainThread]: 
[0m14:50:02.597257 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:50:02.597670 [info ] [MainThread]: 
[0m14:50:02.598372 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:50:02.602968 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:50:02.603485 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:03.429803 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m14:50:03.430467 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:50:04.061017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb52c891b10>]}
[0m14:50:04.061688 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:50:04.111182 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m14:50:04.112555 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m14:50:04.113544 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m14:50:04.114306 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis.abordagem_repeat ................. [RUN]
[0m14:50:04.115194 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m14:50:04.115976 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m14:50:04.116516 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m14:50:04.117093 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m14:50:04.127912 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m14:50:04.134502 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:50:04.135633 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m14:50:04.136185 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m14:50:04.152546 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:50:04.156509 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:50:04.799437 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:50:04.801391 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m14:50:04.802839 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  IFNULL(aceita_acolhimento, 'N/A') AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:50:04.804059 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m14:50:05.279585 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:f1f01355-6a9f-4af9-8fda-911e865e425e&page=queryresults
[0m14:50:05.331727 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:cde51e31-113e-45cf-a49d-9e48f85dfacd&page=queryresults
[0m14:50:09.417454 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50cd87310>]}
[0m14:50:09.418401 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (177.9k rows, 29.9 MiB processed)[0m in 5.30s]
[0m14:50:09.419215 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m14:50:17.224924 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '12743954-6c4f-467a-9552-608f7e9c392e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb50ca3ecd0>]}
[0m14:50:17.225819 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis.abordagem_repeat ............ [[32mCREATE TABLE (252.7k rows, 290.0 MiB processed)[0m in 13.11s]
[0m14:50:17.226701 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m14:50:17.228828 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:50:17.274269 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:50:17.274790 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m14:50:17.275233 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:50:17.275776 [info ] [MainThread]: 
[0m14:50:17.276210 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 14.68 seconds (14.68s).
[0m14:50:17.277109 [debug] [MainThread]: Command end result
[0m14:50:17.299016 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m14:50:17.300861 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m14:50:17.306626 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/queries/target/run_results.json
[0m14:50:17.307000 [info ] [MainThread]: 
[0m14:50:17.307438 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:50:17.307906 [info ] [MainThread]: 
[0m14:50:17.308283 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m14:50:17.308972 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 19.777876, "process_in_blocks": "311792", "process_kernel_time": 1.29934, "process_mem_max_rss": "422268", "process_out_blocks": "2272", "process_user_time": 5.28469}
[0m14:50:17.309413 [debug] [MainThread]: Command `dbt run` succeeded at 14:50:17.309319 after 19.78 seconds
[0m14:50:17.309790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5307d6cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5307d6c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5307d7c10>]}
[0m14:50:17.310228 [debug] [MainThread]: Flushing usage events
[0m14:50:17.896002 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:26:54.899637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7694dba90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7696c9850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb7696c98d0>]}


============================== 22:26:54.904356 | 94a4c53c-2be3-402b-b3e5-3b210e4cd9db ==============================
[0m22:26:54.904356 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:26:54.905137 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/root/.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/root/pipelines/arcgis/queries/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:27:00.100649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74a2a1690>]}
[0m22:27:00.180854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb76beef550>]}
[0m22:27:00.181615 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:27:00.353807 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m22:27:00.632464 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:27:00.633171 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:27:00.916490 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb749d5f910>]}
[0m22:27:01.001842 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m22:27:01.014955 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m22:27:01.048671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb749e70a90>]}
[0m22:27:01.049573 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m22:27:01.050152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb749e25d90>]}
[0m22:27:01.052812 [info ] [MainThread]: 
[0m22:27:01.053465 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:27:01.053958 [info ] [MainThread]: 
[0m22:27:01.054779 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:27:01.061376 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m22:27:01.062212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:27:01.835136 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis)
[0m22:27:01.836199 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:27:02.509801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb76b99d190>]}
[0m22:27:02.510781 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:27:02.590003 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m22:27:02.590823 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m22:27:02.591794 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis.abordagem_ficha .................. [RUN]
[0m22:27:02.592740 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis.abordagem_repeat ................. [RUN]
[0m22:27:02.593539 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis, now model.queries.abordagem_ficha)
[0m22:27:02.594347 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m22:27:02.594820 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m22:27:02.595543 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m22:27:02.606684 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m22:27:02.612665 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m22:27:02.614997 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m22:27:02.620820 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m22:27:02.645082 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:27:02.646184 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m22:27:03.315666 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m22:27:03.318408 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  IFNULL(aceita_acolhimento, 'N/A') AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m22:27:03.376728 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m22:27:03.377695 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m22:27:03.943737 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:c7d57634-e064-455c-a6d9-788e8f4652e7&page=queryresults
[0m22:27:03.959941 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:de202dbc-4c3c-4dfa-b45c-b62c1133401c&page=queryresults
[0m22:27:08.136489 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb74a10c8d0>]}
[0m22:27:08.137531 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis.abordagem_ficha ............. [[32mCREATE TABLE (178.2k rows, 29.9 MiB processed)[0m in 5.54s]
[0m22:27:08.138257 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m22:27:14.794089 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94a4c53c-2be3-402b-b3e5-3b210e4cd9db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb749d8a590>]}
[0m22:27:14.795066 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis.abordagem_repeat ............ [[32mCREATE TABLE (253.0k rows, 290.5 MiB processed)[0m in 12.20s]
[0m22:27:14.795763 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m22:27:14.797287 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:27:14.840974 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:27:14.841463 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m22:27:14.841791 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m22:27:14.842268 [info ] [MainThread]: 
[0m22:27:14.842692 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 13.79 seconds (13.79s).
[0m22:27:14.843551 [debug] [MainThread]: Command end result
[0m22:27:14.868816 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m22:27:14.870519 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m22:27:14.876213 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/queries/target/run_results.json
[0m22:27:14.876635 [info ] [MainThread]: 
[0m22:27:14.877100 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:27:14.877462 [info ] [MainThread]: 
[0m22:27:14.877852 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m22:27:14.878508 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 20.04947, "process_in_blocks": "315648", "process_kernel_time": 1.282607, "process_mem_max_rss": "421164", "process_out_blocks": "2272", "process_user_time": 5.661557}
[0m22:27:14.879006 [debug] [MainThread]: Command `dbt run` succeeded at 22:27:14.878894 after 20.05 seconds
[0m22:27:14.879524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb76d9d3750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb76d9d38d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb76d9d3790>]}
[0m22:27:14.879954 [debug] [MainThread]: Flushing usage events
[0m22:27:15.425508 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:35:01.873469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce2d31480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce1d13ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce1d13a60>]}


============================== 20:35:01.886202 | f0fa07b1-411e-47fa-960c-17e8ad687e8f ==============================
[0m20:35:01.886202 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:35:01.887415 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/root/pipelines_dev/arcgis/queries/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt debug --target dev', 'send_anonymous_usage_stats': 'True'}
[0m20:35:01.897872 [info ] [MainThread]: dbt version: 1.9.4
[0m20:35:01.898745 [info ] [MainThread]: python version: 3.10.13
[0m20:35:01.899278 [info ] [MainThread]: python path: /root/venv-abordagem-dev/bin/python
[0m20:35:01.899827 [info ] [MainThread]: os info: Linux-6.1.0-34-amd64-x86_64-with-glibc2.36
[0m20:35:01.900295 [info ] [MainThread]: Using profiles dir at queries
[0m20:35:01.901068 [info ] [MainThread]: Using profiles.yml file at queries/profiles.yml
[0m20:35:01.901604 [info ] [MainThread]: Using dbt_project.yml file at /root/pipelines_dev/arcgis/queries/dbt_project.yml
[0m20:35:02.114202 [info ] [MainThread]: Configuration:
[0m20:35:02.115057 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m20:35:02.115657 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m20:35:02.116199 [info ] [MainThread]: Required dependencies:
[0m20:35:02.116777 [debug] [MainThread]: Executing "git --help"
[0m20:35:02.119185 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m20:35:02.120028 [debug] [MainThread]: STDERR: "b''"
[0m20:35:02.120728 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m20:35:02.121327 [info ] [MainThread]: Connection test skipped since no profile was found
[0m20:35:02.121837 [info ] [MainThread]: [31m1 check failed:[0m
[0m20:35:02.122480 [info ] [MainThread]: dbt looked for a profiles.yml file in queries/profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m20:35:02.123783 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.38226038, "process_in_blocks": "8", "process_kernel_time": 0.120996, "process_mem_max_rss": "98752", "process_out_blocks": "16", "process_user_time": 2.448018}
[0m20:35:02.124487 [debug] [MainThread]: Command `dbt debug` failed at 20:35:02.124354 after 0.38 seconds
[0m20:35:02.125008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce2d31480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce1d13910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4ce4587310>]}
[0m20:35:02.125536 [debug] [MainThread]: Flushing usage events
[0m20:35:02.732402 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:41:01.797346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e26055420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e25233a30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e25233a00>]}


============================== 20:41:01.802595 | c25722ef-9c41-406e-b4b7-636f3c2d16f0 ==============================
[0m20:41:01.802595 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:41:01.803543 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'queries/logs', 'fail_fast': 'False', 'profiles_dir': 'queries', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug --project-dir queries --profiles-dir queries', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:41:01.830137 [info ] [MainThread]: dbt version: 1.9.4
[0m20:41:01.831201 [info ] [MainThread]: python version: 3.10.13
[0m20:41:01.831905 [info ] [MainThread]: python path: /root/venv-abordagem-dev/bin/python
[0m20:41:01.832621 [info ] [MainThread]: os info: Linux-6.1.0-34-amd64-x86_64-with-glibc2.36
[0m20:41:07.947707 [info ] [MainThread]: Using profiles dir at queries
[0m20:41:07.948633 [info ] [MainThread]: Using profiles.yml file at queries/profiles.yml
[0m20:41:07.949053 [info ] [MainThread]: Using dbt_project.yml file at queries/dbt_project.yml
[0m20:41:07.949565 [info ] [MainThread]: adapter type: bigquery
[0m20:41:07.949975 [info ] [MainThread]: adapter version: 1.9.2
[0m20:41:08.134969 [info ] [MainThread]: Configuration:
[0m20:41:08.135662 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m20:41:08.136075 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m20:41:08.136475 [info ] [MainThread]: Required dependencies:
[0m20:41:08.136893 [debug] [MainThread]: Executing "git --help"
[0m20:41:08.139217 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m20:41:08.139755 [debug] [MainThread]: STDERR: "b''"
[0m20:41:08.140338 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m20:41:08.140820 [info ] [MainThread]: Connection:
[0m20:41:08.141335 [info ] [MainThread]:   method: service-account
[0m20:41:08.141801 [info ] [MainThread]:   database: rj-smas-dev
[0m20:41:08.142262 [info ] [MainThread]:   execution_project: rj-smas-dev
[0m20:41:08.142696 [info ] [MainThread]:   schema: dashboard_arcgis_dev
[0m20:41:08.143089 [info ] [MainThread]:   location: US
[0m20:41:08.143563 [info ] [MainThread]:   priority: None
[0m20:41:08.143962 [info ] [MainThread]:   maximum_bytes_billed: None
[0m20:41:08.144531 [info ] [MainThread]:   impersonate_service_account: None
[0m20:41:08.144959 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m20:41:08.145351 [info ] [MainThread]:   job_retries: 1
[0m20:41:08.145758 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m20:41:08.146309 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m20:41:08.146797 [info ] [MainThread]:   timeout_seconds: 300
[0m20:41:08.147183 [info ] [MainThread]:   client_id: None
[0m20:41:08.147672 [info ] [MainThread]:   token_uri: None
[0m20:41:08.148062 [info ] [MainThread]:   compute_region: None
[0m20:41:08.148476 [info ] [MainThread]:   dataproc_cluster_name: None
[0m20:41:08.148953 [info ] [MainThread]:   gcs_bucket: None
[0m20:41:08.149324 [info ] [MainThread]:   dataproc_batch: None
[0m20:41:08.150112 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m20:41:08.425704 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m20:41:08.426364 [debug] [MainThread]: On debug: select 1 as id
[0m20:41:08.426843 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:41:09.219134 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:831dd80a-59c7-4580-9b57-87a733587c4e&page=queryresults
[0m20:41:09.884735 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m20:41:09.885438 [info ] [MainThread]: [32mAll checks passed![0m
[0m20:41:09.886280 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 8.211105, "process_in_blocks": "352528", "process_kernel_time": 0.86616, "process_mem_max_rss": "373408", "process_out_blocks": "24", "process_user_time": 6.321073}
[0m20:41:09.886904 [debug] [MainThread]: Command `dbt debug` succeeded at 20:41:09.886770 after 8.21 seconds
[0m20:41:09.887415 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m20:41:09.887890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e26055420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e0612a950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f6e061b7bb0>]}
[0m20:41:09.888460 [debug] [MainThread]: Flushing usage events
[0m20:41:10.459754 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:41:37.747035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19c75d450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19b94bb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19b94baf0>]}


============================== 20:41:37.751890 | d624f429-ecf5-4047-a69f-f6430742553d ==============================
[0m20:41:37.751890 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:41:37.752736 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'queries/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:41:43.307321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19e2d4cd0>]}
[0m20:41:43.418120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc181b5fa00>]}
[0m20:41:43.419142 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m20:41:43.692152 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m20:41:43.842682 [info ] [MainThread]: Unable to do partial parsing because config vars, config profile, or config target have changed
[0m20:41:43.843363 [debug] [MainThread]: previous checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, current checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c
[0m20:41:43.843824 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m20:41:43.844290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19bdbc280>]}
[0m20:41:45.925267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc17bba4490>]}
[0m20:41:46.055941 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m20:41:46.059197 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m20:41:46.103726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc17b9e9450>]}
[0m20:41:46.104546 [info ] [MainThread]: Found 2 models, 2 sources, 493 macros
[0m20:41:46.105040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc17b9e81f0>]}
[0m20:41:46.107219 [info ] [MainThread]: 
[0m20:41:46.107708 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:41:46.108171 [info ] [MainThread]: 
[0m20:41:46.108875 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:41:46.115542 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m20:41:46.116469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:41:46.929560 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m20:41:46.931182 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:41:47.600108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19b8e60b0>]}
[0m20:41:47.600998 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:41:47.652758 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m20:41:47.654444 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m20:41:47.653881 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.abordagem_ficha .............. [RUN]
[0m20:41:47.655380 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m20:41:47.656156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_ficha)
[0m20:41:47.656866 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m20:41:47.657437 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m20:41:47.657995 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m20:41:47.673021 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m20:41:47.680230 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m20:41:47.681428 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m20:41:47.689124 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m20:41:47.780643 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m20:41:47.783233 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m20:41:47.785408 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m20:41:47.787294 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m20:41:47.788359 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m20:41:47.789781 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:41:48.707288 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:d8ab7819-e918-4ed3-a650-7bd850f046c1&page=queryresults
[0m20:41:48.727990 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:6e4302fd-c3dc-42be-91c0-4afc9ff2094d&page=queryresults
[0m20:41:52.637488 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc17b9e8ee0>]}
[0m20:41:52.638754 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_ficha ......... [[32mCREATE TABLE (184.6k rows, 31.2 MiB processed)[0m in 4.98s]
[0m20:41:52.639834 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m20:41:58.298933 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd624f429-ecf5-4047-a69f-f6430742553d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc17b9e89d0>]}
[0m20:41:58.300182 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (260.9k rows, 301.9 MiB processed)[0m in 10.64s]
[0m20:41:58.301226 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m20:41:58.303390 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:41:58.355404 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:41:58.356028 [debug] [MainThread]: Connection 'model.queries.abordagem_ficha' was properly closed.
[0m20:41:58.356434 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m20:41:58.356954 [info ] [MainThread]: 
[0m20:41:58.357429 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 12.25 seconds (12.25s).
[0m20:41:58.358599 [debug] [MainThread]: Command end result
[0m20:41:58.389183 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m20:41:58.391575 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m20:41:58.400796 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m20:41:58.401401 [info ] [MainThread]: 
[0m20:41:58.401941 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:41:58.402406 [info ] [MainThread]: 
[0m20:41:58.402862 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m20:41:58.403603 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 20.747574, "process_in_blocks": "415512", "process_kernel_time": 1.062724, "process_mem_max_rss": "403436", "process_out_blocks": "3464", "process_user_time": 8.770522}
[0m20:41:58.404194 [debug] [MainThread]: Command `dbt run` succeeded at 20:41:58.404058 after 20.75 seconds
[0m20:41:58.404713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19c75d450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19e2d4cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc19c828820>]}
[0m20:41:58.405233 [debug] [MainThread]: Flushing usage events
[0m20:41:58.941963 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:32:58.154204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389ee753c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389e05fb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389e05faf0>]}


============================== 21:32:58.157509 | 0315bdab-60f8-43e6-909d-30b531e9b035 ==============================
[0m21:32:58.157509 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:32:58.158176 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:33:02.043562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f38a0a5ccd0>]}
[0m21:33:02.171119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389f01f520>]}
[0m21:33:02.172225 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:33:02.460017 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:33:02.656852 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:33:02.657787 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:33:03.248733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f387e0f8100>]}
[0m21:33:03.389215 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:33:03.391434 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:33:03.404146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f387e0f83d0>]}
[0m21:33:03.404925 [info ] [MainThread]: Found 3 models, 2 sources, 493 macros
[0m21:33:03.405384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f387ebb0f40>]}
[0m21:33:03.406992 [info ] [MainThread]: 
[0m21:33:03.407474 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:33:03.407883 [info ] [MainThread]: 
[0m21:33:03.408650 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:33:03.410231 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:33:03.411130 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:33:04.083082 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:33:04.083927 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:33:04.689516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389e007d30>]}
[0m21:33:04.690607 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:33:04.742036 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:33:04.743051 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:33:04.743794 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:33:04.744359 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:33:04.757574 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:33:04.758714 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:33:04.795931 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:33:04.797091 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

-- ───────────── UDF local p/ reutilizar ─────────────────────────────────────────
CREATE TEMP FUNCTION fn_clean_name(s STRING)
RETURNS STRING
LANGUAGE js AS """
  // 1) para minúsculo
  s = (s || '').toLowerCase();

  // 2) remove acentos (NFD → só letras ASCII)
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

  // 3) remove pontuação
  s = s.replace(/[^a-z\s]/g, ' ');

  // 4) remove stop-words PT (lista sintética; ajustamos depois)
  const stop = new Set(['de','da','do','das','dos','e','a','o','os','as']);
  s = s
    .split(/\s+/)
    .filter(t => t && !stop.has(t))
    .join(' ');

  return s.trim();
""";

-- ───────────── SELECT base ─────────────────────────────────────────────────────
SELECT
  parentrowid,
  -- nomes originais
  repeat_nome_usuario,
  repeat_nome_mae,

  -- versões limpas
  fn_clean_name(repeat_nome_usuario) AS nome_usuario_norm,
  fn_clean_name(repeat_nome_mae)     AS nome_mae_norm
FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`;


[0m21:33:04.797729 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:33:05.467351 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:5e5918bf-41fe-4dd2-afd0-642c6b8936b6&page=queryresults
[0m21:33:05.468370 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:5e5918bf-41fe-4dd2-afd0-642c6b8936b6&page=queryresults
[0m21:33:05.483004 [debug] [Thread-1 (]: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected keyword CREATE at [9:1]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:33:05.485669 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0315bdab-60f8-43e6-909d-30b531e9b035', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389f153370>]}
[0m21:33:05.486605 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model dashboard_arcgis_dev.stg_repeat_names ..... [[31mERROR[0m in 0.74s]
[0m21:33:05.487317 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:33:05.488079 [debug] [Thread-5 (]: Marking all children of 'model.queries.stg_repeat_names' to be skipped because of status 'error'.  Reason: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected keyword CREATE at [9:1]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql.
[0m21:33:05.490865 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:33:05.538384 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:33:05.539112 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:33:05.539610 [info ] [MainThread]: 
[0m21:33:05.540224 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.13 seconds (2.13s).
[0m21:33:05.541245 [debug] [MainThread]: Command end result
[0m21:33:05.572896 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:33:05.575042 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:33:05.587705 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:33:05.588370 [info ] [MainThread]: 
[0m21:33:05.588908 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m21:33:05.589442 [info ] [MainThread]: 
[0m21:33:05.590069 [error] [MainThread]:   Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected keyword CREATE at [9:1]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:33:05.590524 [info ] [MainThread]: 
[0m21:33:05.590979 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:33:05.591720 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 7.5407434, "process_in_blocks": "552", "process_kernel_time": 0.900463, "process_mem_max_rss": "395360", "process_out_blocks": "3200", "process_user_time": 7.358807}
[0m21:33:05.592303 [debug] [MainThread]: Command `dbt run` failed at 21:33:05.592174 after 7.54 seconds
[0m21:33:05.592826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389ee753c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f387e0e8580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f389ef188b0>]}
[0m21:33:05.593366 [debug] [MainThread]: Flushing usage events
[0m21:33:06.145837 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:38:06.210647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d0631330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93cf623a30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93cf6239d0>]}


============================== 21:38:06.214705 | 1e2c9a77-b25e-4c79-9f0b-2255f299a4f3 ==============================
[0m21:38:06.214705 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:38:06.215648 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:38:10.225184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b5869000>]}
[0m21:38:10.349327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b0716da0>]}
[0m21:38:10.350525 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:38:10.655501 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:38:10.845422 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m21:38:10.846288 [debug] [MainThread]: Partial parsing: added file: queries://macros/clean_name.sql
[0m21:38:10.846938 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:38:11.395400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b06a5ba0>]}
[0m21:38:11.517696 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:38:11.520160 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:38:11.535516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b018c7f0>]}
[0m21:38:11.536579 [info ] [MainThread]: Found 3 models, 2 sources, 494 macros
[0m21:38:11.537263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b018d390>]}
[0m21:38:11.539690 [info ] [MainThread]: 
[0m21:38:11.540307 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:38:11.540742 [info ] [MainThread]: 
[0m21:38:11.541549 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:38:11.543364 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:38:11.544421 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:38:12.278616 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:38:12.279379 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:38:12.929145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d1c17f10>]}
[0m21:38:12.930350 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:38:12.980701 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:38:12.981616 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:38:12.982293 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:38:12.982792 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:38:12.999126 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:38:13.000488 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:38:13.059755 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:38:13.061040 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- explode em palavras já normalizadas
    SPLIT(
    -- 1) minúsculo + strip acentos
    REGEXP_REPLACE(
      REGEXP_REPLACE(
        LOWER(
          REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'[\u0300-\u036f]', '')
        ),
        r'[^a-z\s]',            -- 2) remove pontuação
        ' '
      ),
      r'\s+', ' '              -- 3) espaços duplicados
    )
, ' ')     AS arr_usuario,
    SPLIT(
    -- 1) minúsculo + strip acentos
    REGEXP_REPLACE(
      REGEXP_REPLACE(
        LOWER(
          REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'[\u0300-\u036f]', '')
        ),
        r'[^a-z\s]',            -- 2) remove pontuação
        ' '
      ),
      r'\s+', ' '              -- 3) espaços duplicados
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m21:38:13.061692 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:13.943412 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:fb8c66d7-c16d-4b5d-94b8-b209f312b9db&page=queryresults
[0m21:38:14.558096 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e2c9a77-b25e-4c79-9f0b-2255f299a4f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b5869180>]}
[0m21:38:14.559171 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names ......... [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m21:38:14.559972 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:38:14.561841 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:38:14.608958 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:38:14.609743 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:38:14.610349 [info ] [MainThread]: 
[0m21:38:14.610989 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.07 seconds (3.07s).
[0m21:38:14.612177 [debug] [MainThread]: Command end result
[0m21:38:14.649897 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:38:14.652392 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:38:14.661663 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:38:14.662352 [info ] [MainThread]: 
[0m21:38:14.663033 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:38:14.663512 [info ] [MainThread]: 
[0m21:38:14.664031 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:38:14.664774 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.571086, "process_in_blocks": "0", "process_kernel_time": 0.821479, "process_mem_max_rss": "400680", "process_out_blocks": "3192", "process_user_time": 7.647305}
[0m21:38:14.665379 [debug] [MainThread]: Command `dbt run` succeeded at 21:38:14.665260 after 8.57 seconds
[0m21:38:14.665961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93d0631330>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93b0716da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93cf5cbeb0>]}
[0m21:38:14.666596 [debug] [MainThread]: Flushing usage events
[0m21:38:15.248020 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:45:46.830143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4aa01693c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a9f357b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a9f357af0>]}


============================== 21:45:46.833411 | 6957b750-013e-44fb-be5a-b06421b29b3e ==============================
[0m21:45:46.833411 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:45:46.834051 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'warn_error': 'None', 'log_path': 'queries/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'send_anonymous_usage_stats': 'True'}
[0m21:45:50.438366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4aa1cc4cd0>]}
[0m21:45:50.545959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4aa0313520>]}
[0m21:45:50.546906 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:45:50.836437 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:45:51.039035 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:45:51.040050 [debug] [MainThread]: Partial parsing: updated file: queries://macros/clean_name.sql
[0m21:45:51.569934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a80247040>]}
[0m21:45:51.700734 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:45:51.703052 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:45:51.715699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a7fd9fac0>]}
[0m21:45:51.716661 [info ] [MainThread]: Found 3 models, 2 sources, 494 macros
[0m21:45:51.717179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a80056da0>]}
[0m21:45:51.718908 [info ] [MainThread]: 
[0m21:45:51.719460 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:45:51.719920 [info ] [MainThread]: 
[0m21:45:51.720710 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:45:51.722212 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:45:51.723308 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:45:52.489568 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:45:52.490584 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:45:53.121743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a9f2ffd30>]}
[0m21:45:53.122604 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:45:53.172187 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:45:53.173198 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:45:53.173935 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:45:53.174514 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:45:53.186245 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:45:53.187323 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:45:53.226902 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:45:53.228004 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- explode em palavras já normalizadas
    SPLIT(
    -- 1) minúsculo + strip acentos
    REGEXP_REPLACE(
      REGEXP_REPLACE(
        LOWER(
          REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')
        ),
        r'[^a-z\s]',            -- 2) remove pontuação
        ' '
      ),
      r'\s+', ' '              -- 3) espaços duplicados
    )
, ' ')     AS arr_usuario,
    SPLIT(
    -- 1) minúsculo + strip acentos
    REGEXP_REPLACE(
      REGEXP_REPLACE(
        LOWER(
          REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')
        ),
        r'[^a-z\s]',            -- 2) remove pontuação
        ' '
      ),
      r'\s+', ' '              -- 3) espaços duplicados
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m21:45:53.228615 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:45:54.107463 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:9e6ce86d-e4bb-4f59-ad9c-84f35aa6b486&page=queryresults
[0m21:45:54.720312 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6957b750-013e-44fb-be5a-b06421b29b3e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a855cc6d0>]}
[0m21:45:54.721801 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names ......... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m21:45:54.722959 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:45:54.725216 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:45:54.777107 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:45:54.777681 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:45:54.778127 [info ] [MainThread]: 
[0m21:45:54.778620 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.06 seconds (3.06s).
[0m21:45:54.779408 [debug] [MainThread]: Command end result
[0m21:45:54.810020 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:45:54.812541 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:45:54.822536 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:45:54.823163 [info ] [MainThread]: 
[0m21:45:54.823801 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:45:54.824398 [info ] [MainThread]: 
[0m21:45:54.824939 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:45:54.826061 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.096918, "process_in_blocks": "0", "process_kernel_time": 0.696959, "process_mem_max_rss": "402448", "process_out_blocks": "3200", "process_user_time": 7.097725}
[0m21:45:54.826830 [debug] [MainThread]: Command `dbt run` succeeded at 21:45:54.826671 after 8.10 seconds
[0m21:45:54.827383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4aa01693c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4aa1cc4cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a802467a0>]}
[0m21:45:54.828106 [debug] [MainThread]: Flushing usage events
[0m21:45:55.411215 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:33:12.962090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaecb69480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaebd57bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaebd57b50>]}


============================== 22:33:12.968067 | a1a85830-3105-4c9d-930c-6f3edeac0c78 ==============================
[0m22:33:12.968067 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:33:12.968779 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'queries/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'send_anonymous_usage_stats': 'True'}
[0m22:33:18.571159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdacce6fc70>]}
[0m22:33:18.685607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaccee6a10>]}
[0m22:33:18.686748 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:33:18.970478 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m22:33:19.219668 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:33:19.220734 [debug] [MainThread]: Partial parsing: updated file: queries://macros/clean_name.sql
[0m22:33:19.744852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaccc57310>]}
[0m22:33:19.884538 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m22:33:19.887432 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m22:33:19.912651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdacc9f4400>]}
[0m22:33:19.913425 [info ] [MainThread]: Found 3 models, 2 sources, 494 macros
[0m22:33:19.913980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdacc9f4550>]}
[0m22:33:19.915795 [info ] [MainThread]: 
[0m22:33:19.916450 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:33:19.916876 [info ] [MainThread]: 
[0m22:33:19.917645 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:33:19.919391 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m22:33:19.920347 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:33:21.712502 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m22:33:21.713343 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:33:22.388966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaebcf20e0>]}
[0m22:33:22.389772 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:33:22.438546 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m22:33:22.439532 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m22:33:22.440350 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m22:33:22.440940 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m22:33:22.452834 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m22:33:22.453719 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m22:33:22.492274 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m22:33:22.493518 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m22:33:22.494203 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:33:23.443633 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:069fbca6-c5b8-4cd7-bf49-71b35c0b393a&page=queryresults
[0m22:33:24.083604 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a1a85830-3105-4c9d-930c-6f3edeac0c78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdad1fe42e0>]}
[0m22:33:24.084876 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names ......... [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m22:33:24.085709 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m22:33:24.087988 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:33:24.137829 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:33:24.138690 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m22:33:24.139198 [info ] [MainThread]: 
[0m22:33:24.139683 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.22 seconds (4.22s).
[0m22:33:24.140732 [debug] [MainThread]: Command end result
[0m22:33:24.172342 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m22:33:24.174817 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m22:33:24.187204 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m22:33:24.187761 [info ] [MainThread]: 
[0m22:33:24.188371 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:33:24.188775 [info ] [MainThread]: 
[0m22:33:24.189241 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:33:24.189937 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 11.343941, "process_in_blocks": "415328", "process_kernel_time": 1.120025, "process_mem_max_rss": "398120", "process_out_blocks": "3192", "process_user_time": 7.181802}
[0m22:33:24.190552 [debug] [MainThread]: Command `dbt run` succeeded at 22:33:24.190429 after 11.34 seconds
[0m22:33:24.191064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaecb69480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdaecc0dab0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdacce6fc70>]}
[0m22:33:24.191573 [debug] [MainThread]: Flushing usage events
[0m22:33:24.779809 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:50:09.490526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2278839450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2277a27b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2277a27b20>]}


============================== 15:50:09.496426 | eb4651fa-8061-4d1f-aa59-27dd753127b0 ==============================
[0m15:50:09.496426 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:50:09.497381 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:50:15.254781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f227a3c0cd0>]}
[0m15:50:15.364153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f225dc91930>]}
[0m15:50:15.365273 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m15:50:15.636584 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m15:50:15.938751 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m15:50:15.939897 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m15:50:16.429262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2257a40130>]}
[0m15:50:16.551164 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m15:50:16.554359 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m15:50:16.593819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2258842fe0>]}
[0m15:50:16.594907 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m15:50:16.595520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2258840280>]}
[0m15:50:16.597391 [info ] [MainThread]: 
[0m15:50:16.597959 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:50:16.598457 [info ] [MainThread]: 
[0m15:50:16.599227 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:50:16.601453 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m15:50:16.603164 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:50:17.320623 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m15:50:17.321407 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:50:17.973127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f22779c0d90>]}
[0m15:50:17.973857 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:50:18.025554 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m15:50:18.026581 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names_cluster ...... [RUN]
[0m15:50:18.027258 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m15:50:18.027760 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m15:50:18.039540 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m15:50:18.040484 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m15:50:18.079727 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m15:50:18.080801 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    nome_usuario_norm AS nm,
    nome_mae_norm     AS mm
  FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 1) BLOQUEIO por SOUNDEX (evita pair-wise N²)
blocked AS (
  SELECT *,
         SOUNDEX(nm) AS sx_nm,
         SOUNDEX(mm) AS sx_mm
  FROM base
),

-- 2) GERAR pares só dentro do bloco
pairs AS (
  SELECT
    a.parentrowid AS id_a,
    b.parentrowid AS id_b,

    LEVENSHTEIN_DISTANCE(a.nm, b.nm) AS d_nm,
    LEVENSHTEIN_DISTANCE(a.mm, b.mm) AS d_mm,

    -- tokens
    SPLIT(a.nm, ' ') AS arr_nm_a,
    SPLIT(b.nm, ' ') AS arr_nm_b,
    SPLIT(a.mm, ' ') AS arr_mm_a,
    SPLIT(b.mm, ' ') AS arr_mm_b
  FROM blocked a
  JOIN blocked b
    ON a.sx_nm = b.sx_nm AND a.sx_mm = b.sx_mm
   AND a.parentrowid < b.parentrowid             -- evita espelho
),

-- 3) MÉTRICAS de contenção (tokens_inter / tokens_menor)
scored AS (
  SELECT *,
    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_nm_a) x
                             INNER JOIN UNNEST(arr_nm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_nm_a), ARRAY_LENGTH(arr_nm_b))         AS cont_nm,

    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_mm_a) x
                             INNER JOIN UNNEST(arr_mm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_mm_a), ARRAY_LENGTH(arr_mm_b))         AS cont_mm
  FROM pairs
),

-- 4) REGRA DE MATCH
dupes AS (
  SELECT id_a, id_b
  FROM scored
  WHERE
        (d_nm <= 2 OR cont_nm >= 0.8)
    AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 5) CLUSTER  ➜ menor parentrowid do grupo
cluster_map AS (
  SELECT id_a AS parentrowid, LEAST(id_a, MIN(id_b)) AS seed
  FROM dupes
  GROUP BY id_a

  UNION ALL

  SELECT parentrowid, parentrowid
  FROM base                                   -- singletons
)

SELECT
  b.*,
  MIN(seed) OVER (PARTITION BY seed) AS cluster_id,
  COUNT(*)  OVER (PARTITION BY seed) AS cluster_size
FROM base b
LEFT JOIN cluster_map USING (parentrowid);


[0m15:50:18.081416 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:50:19.123291 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:9b9ee32d-8b1c-4d96-8e81-69b4ea61c1a5&page=queryresults
[0m15:50:19.391884 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:9b9ee32d-8b1c-4d96-8e81-69b4ea61c1a5&page=queryresults
[0m15:50:19.403478 [debug] [Thread-1 (]: Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Function not found: LEVENSHTEIN_DISTANCE at [30:5]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m15:50:19.407872 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb4651fa-8061-4d1f-aa59-27dd753127b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f22585d3f40>]}
[0m15:50:19.409369 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model dashboard_arcgis_dev.stg_repeat_names_cluster  [[31mERROR[0m in 1.38s]
[0m15:50:19.410449 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m15:50:19.411650 [debug] [Thread-5 (]: Marking all children of 'model.queries.stg_repeat_names_cluster' to be skipped because of status 'error'.  Reason: Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Function not found: LEVENSHTEIN_DISTANCE at [30:5]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql.
[0m15:50:19.414465 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:50:19.464795 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:50:19.465507 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m15:50:19.465980 [info ] [MainThread]: 
[0m15:50:19.466487 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.87 seconds (2.87s).
[0m15:50:19.467320 [debug] [MainThread]: Command end result
[0m15:50:19.503053 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m15:50:19.505538 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m15:50:19.514414 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m15:50:19.515156 [info ] [MainThread]: 
[0m15:50:19.515723 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:50:19.516221 [info ] [MainThread]: 
[0m15:50:19.516782 [error] [MainThread]:   Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Function not found: LEVENSHTEIN_DISTANCE at [30:5]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m15:50:19.517269 [info ] [MainThread]: 
[0m15:50:19.517771 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:50:19.518565 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 10.139207, "process_in_blocks": "416472", "process_kernel_time": 1.18725, "process_mem_max_rss": "393624", "process_out_blocks": "3240", "process_user_time": 7.196341}
[0m15:50:19.519237 [debug] [MainThread]: Command `dbt run` failed at 15:50:19.519079 after 10.14 seconds
[0m15:50:19.520011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2278839450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f22584004c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f22788dc550>]}
[0m15:50:19.520731 [debug] [MainThread]: Flushing usage events
[0m15:50:20.153660 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:52:20.604404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f2d793f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f1f67af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f1f67a90>]}


============================== 15:52:20.608918 | 47177b53-1479-4773-9438-db4279d0b109 ==============================
[0m15:52:20.608918 [info ] [MainThread]: Running with dbt=1.9.4
[0m15:52:20.609880 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'send_anonymous_usage_stats': 'True'}
[0m15:52:24.554114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f48cccd0>]}
[0m15:52:24.695954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f47b3130>]}
[0m15:52:24.697122 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m15:52:24.972077 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m15:52:25.154788 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:52:25.155717 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m15:52:25.658201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6d2184130>]}
[0m15:52:25.792893 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m15:52:25.795295 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m15:52:25.809376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6d21855a0>]}
[0m15:52:25.810177 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m15:52:25.810785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6d2db4e80>]}
[0m15:52:25.812709 [info ] [MainThread]: 
[0m15:52:25.813297 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:52:25.813711 [info ] [MainThread]: 
[0m15:52:25.814459 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:52:25.816463 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m15:52:25.817847 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:52:26.479041 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m15:52:26.479921 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:52:27.182975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f4563f10>]}
[0m15:52:27.183758 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:52:27.233308 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m15:52:27.234530 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names_cluster ...... [RUN]
[0m15:52:27.235374 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m15:52:27.235946 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m15:52:27.248545 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m15:52:27.249712 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m15:52:27.291087 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m15:52:27.292426 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    nome_usuario_norm AS nm,
    nome_mae_norm     AS mm
  FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 1) BLOQUEIO por SOUNDEX (evita pair-wise N²)
blocked AS (
  SELECT *,
         SOUNDEX(nm) AS sx_nm,
         SOUNDEX(mm) AS sx_mm
  FROM base
),

-- 2) GERAR pares só dentro do bloco
pairs AS (
  SELECT
    a.parentrowid AS id_a,
    b.parentrowid AS id_b,

    EDIT_DISTANCE(a.nm, b.nm) AS d_nm,
    EDIT_DISTANCE(a.mm, b.mm) AS d_mm,

    -- tokens
    SPLIT(a.nm, ' ') AS arr_nm_a,
    SPLIT(b.nm, ' ') AS arr_nm_b,
    SPLIT(a.mm, ' ') AS arr_mm_a,
    SPLIT(b.mm, ' ') AS arr_mm_b
  FROM blocked a
  JOIN blocked b
    ON a.sx_nm = b.sx_nm AND a.sx_mm = b.sx_mm
   AND a.parentrowid < b.parentrowid             -- evita espelho
),

-- 3) MÉTRICAS de contenção (tokens_inter / tokens_menor)
scored AS (
  SELECT *,
    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_nm_a) x
                             INNER JOIN UNNEST(arr_nm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_nm_a), ARRAY_LENGTH(arr_nm_b))         AS cont_nm,

    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_mm_a) x
                             INNER JOIN UNNEST(arr_mm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_mm_a), ARRAY_LENGTH(arr_mm_b))         AS cont_mm
  FROM pairs
),

-- 4) REGRA DE MATCH
dupes AS (
  SELECT id_a, id_b
  FROM scored
  WHERE
        (d_nm <= 2 OR cont_nm >= 0.8)
    AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 5) CLUSTER  ➜ menor parentrowid do grupo
cluster_map AS (
  SELECT id_a AS parentrowid, LEAST(id_a, MIN(id_b)) AS seed
  FROM dupes
  GROUP BY id_a

  UNION ALL

  SELECT parentrowid, parentrowid
  FROM base                                   -- singletons
)

SELECT
  b.*,
  MIN(seed) OVER (PARTITION BY seed) AS cluster_id,
  COUNT(*)  OVER (PARTITION BY seed) AS cluster_size
FROM base b
LEFT JOIN cluster_map USING (parentrowid);


[0m15:52:27.293172 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:52:28.315586 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:4d654bd8-06d7-4c1e-ae9a-dc24576295b5&page=queryresults
[0m15:52:29.702664 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '47177b53-1479-4773-9438-db4279d0b109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6d81cc6d0>]}
[0m15:52:29.703806 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names_cluster . [[32mCREATE VIEW (0 processed)[0m in 2.47s]
[0m15:52:29.704771 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m15:52:29.707087 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:52:29.765507 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:52:29.766406 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m15:52:29.767096 [info ] [MainThread]: 
[0m15:52:29.767769 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.95 seconds (3.95s).
[0m15:52:29.769056 [debug] [MainThread]: Command end result
[0m15:52:29.807820 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m15:52:29.810061 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m15:52:29.819561 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m15:52:29.820257 [info ] [MainThread]: 
[0m15:52:29.820897 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:52:29.821390 [info ] [MainThread]: 
[0m15:52:29.821827 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:52:29.822593 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.32502, "process_in_blocks": "1856", "process_kernel_time": 0.829413, "process_mem_max_rss": "400348", "process_out_blocks": "3232", "process_user_time": 7.414046}
[0m15:52:29.823171 [debug] [MainThread]: Command `dbt run` succeeded at 15:52:29.823052 after 9.33 seconds
[0m15:52:29.823695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f2d793f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f48cccd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa6f2e1dcf0>]}
[0m15:52:29.824308 [debug] [MainThread]: Flushing usage events
[0m15:52:30.389973 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:23:39.363201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff767d49450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff766f37b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff766f37b20>]}


============================== 16:23:39.366510 | 76ccdb4c-b98e-40fc-912f-8d39b61248c8 ==============================
[0m16:23:39.366510 [info ] [MainThread]: Running with dbt=1.9.4
[0m16:23:39.368075 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:23:43.044034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff766f37d60>]}
[0m16:23:43.153316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74800e050>]}
[0m16:23:43.154305 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m16:23:43.414671 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m16:23:43.596161 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:23:43.597201 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m16:23:44.107418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff7479c4130>]}
[0m16:23:44.250112 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m16:23:44.252315 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m16:23:44.264960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff7479c5a80>]}
[0m16:23:44.265682 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m16:23:44.266112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff768ae4a90>]}
[0m16:23:44.267695 [info ] [MainThread]: 
[0m16:23:44.268213 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:23:44.269691 [info ] [MainThread]: 
[0m16:23:44.271099 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:23:44.272749 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m16:23:44.273874 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:23:45.028955 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m16:23:45.029989 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:23:45.777068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff769527f10>]}
[0m16:23:45.777948 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:23:45.824470 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m16:23:45.825479 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names_cluster ...... [RUN]
[0m16:23:45.826219 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m16:23:45.826755 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m16:23:45.838725 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m16:23:45.839640 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m16:23:45.876478 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m16:23:45.877711 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    nome_usuario_norm AS nm,
    nome_mae_norm     AS mm
  FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 1) BLOQUEIO ─ só pelo SOUNDEX do nome da pessoa
blocked AS (
  SELECT *,
         SOUNDEX(nm) AS block_key
  FROM base
),

-- 2) GERAR pares dentro do bloco
pairs AS (
  SELECT
    a.parentrowid AS id_a,
    b.parentrowid AS id_b,

    EDIT_DISTANCE(a.nm, b.nm) AS d_nm,
    EDIT_DISTANCE(a.mm, b.mm) AS d_mm,

    SPLIT(a.nm, ' ') AS a_nm_tok,
    SPLIT(b.nm, ' ') AS b_nm_tok,
    SPLIT(a.mm, ' ') AS a_mm_tok,
    SPLIT(b.mm, ' ') AS b_mm_tok
  FROM blocked a
  JOIN blocked b
    ON a.block_key = b.block_key
   AND a.parentrowid < b.parentrowid          -- evita reflexivos
),

-- 3) MÉTRICA de contenção   inter / menor ≥ 0.80
scored AS (
  SELECT *,
    ARRAY_LENGTH(ARRAY(
        SELECT x FROM UNNEST(a_nm_tok) x
        INTERSECT DISTINCT
        SELECT y FROM UNNEST(b_nm_tok) y
    )) / LEAST(ARRAY_LENGTH(a_nm_tok), ARRAY_LENGTH(b_nm_tok))  AS cont_nm,

    ARRAY_LENGTH(ARRAY(
        SELECT x FROM UNNEST(a_mm_tok) x
        INTERSECT DISTINCT
        SELECT y FROM UNNEST(b_mm_tok) y
    )) / LEAST(ARRAY_LENGTH(a_mm_tok), ARRAY_LENGTH(b_mm_tok))  AS cont_mm
  FROM pairs
),

-- 4) DUPLICADOS: (dist ≤2 OR cont ≥0.8) em AMBAS as colunas
dupes AS (
  SELECT id_a, id_b
  FROM scored
  WHERE (d_nm <= 2 OR cont_nm >= 0.8)
    AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 5) CLUSTER: componente conexa via menor parentrowid
graph AS (
  SELECT parentrowid, parentrowid       AS neighbour FROM base   -- singlet
  UNION ALL
  SELECT id_a, id_b FROM dupes
  UNION ALL
  SELECT id_b, id_a FROM dupes          -- torna o grafo não-direcionado
),

clustered AS (
  SELECT
    parentrowid,
    MIN(neighbour) OVER (PARTITION BY parentrowid) AS cluster_seed
  FROM graph
)

SELECT DISTINCT
  b.parentrowid,
  MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
  COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size,
  cluster_size > 1                                   AS is_duplicado
FROM base b
JOIN clustered USING (parentrowid);;


[0m16:23:45.878367 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:23:46.539432 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:e9136a6f-8e1d-4ca2-b1c9-923d936b279c&page=queryresults
[0m16:23:46.540472 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:e9136a6f-8e1d-4ca2-b1c9-923d936b279c&page=queryresults
[0m16:23:46.543934 [debug] [Thread-1 (]: Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Syntax error: Unexpected ";" at [89:36]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m16:23:46.546229 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76ccdb4c-b98e-40fc-912f-8d39b61248c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff768020d00>]}
[0m16:23:46.547164 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model dashboard_arcgis_dev.stg_repeat_names_cluster  [[31mERROR[0m in 0.72s]
[0m16:23:46.547959 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m16:23:46.548992 [debug] [Thread-5 (]: Marking all children of 'model.queries.stg_repeat_names_cluster' to be skipped because of status 'error'.  Reason: Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Syntax error: Unexpected ";" at [89:36]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql.
[0m16:23:46.551971 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:23:46.596738 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:23:46.597555 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m16:23:46.598066 [info ] [MainThread]: 
[0m16:23:46.598591 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.33 seconds (2.33s).
[0m16:23:46.599421 [debug] [MainThread]: Command end result
[0m16:23:46.629861 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m16:23:46.632220 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m16:23:46.640166 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m16:23:46.640798 [info ] [MainThread]: 
[0m16:23:46.641329 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:23:46.641775 [info ] [MainThread]: 
[0m16:23:46.642279 [error] [MainThread]:   Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)
  Syntax error: Unexpected ";" at [89:36]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m16:23:46.642716 [info ] [MainThread]: 
[0m16:23:46.643146 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:23:46.643830 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 7.383572, "process_in_blocks": "0", "process_kernel_time": 0.825488, "process_mem_max_rss": "393976", "process_out_blocks": "3232", "process_user_time": 6.944749}
[0m16:23:46.644591 [debug] [MainThread]: Command `dbt run` failed at 16:23:46.644428 after 7.38 seconds
[0m16:23:46.645257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff767d49450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff747b83bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff766ef7cd0>]}
[0m16:23:46.645795 [debug] [MainThread]: Flushing usage events
[0m16:23:47.210168 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:23:24.986579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff746f7d4b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74616bc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74616bbe0>]}


============================== 17:23:24.990371 | d385a2cc-f69d-4baa-8c45-63b66dd37874 ==============================
[0m17:23:24.990371 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:23:24.991027 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'queries/logs', 'profiles_dir': 'queries', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'send_anonymous_usage_stats': 'True'}
[0m17:23:28.741784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74616bd30>]}
[0m17:23:28.855271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff72700fdc0>]}
[0m17:23:28.856278 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m17:23:29.130268 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m17:23:29.305579 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:23:29.306532 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m17:23:29.792427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff726984130>]}
[0m17:23:29.916056 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m17:23:29.918602 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m17:23:29.932855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff726985a80>]}
[0m17:23:29.933705 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m17:23:29.934147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff747b39cc0>]}
[0m17:23:29.935862 [info ] [MainThread]: 
[0m17:23:29.936343 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:23:29.936764 [info ] [MainThread]: 
[0m17:23:29.937400 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:23:29.938981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m17:23:29.939782 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:23:30.727007 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m17:23:30.728063 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:23:31.418827 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74876bf10>]}
[0m17:23:31.419714 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:23:31.468325 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m17:23:31.469411 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names_cluster ...... [RUN]
[0m17:23:31.470171 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m17:23:31.470735 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m17:23:31.481856 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m17:23:31.482797 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m17:23:31.521160 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m17:23:31.522547 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    nome_usuario_norm AS nm,
    nome_mae_norm     AS mm
  FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 1) BLOQUEIO por SOUNDEX (evita pair-wise N²)
blocked AS (
  SELECT *,
         SOUNDEX(nm) AS sx_nm,
         SOUNDEX(mm) AS sx_mm
  FROM base
),

-- 2) GERAR pares só dentro do bloco
pairs AS (
  SELECT
    a.parentrowid AS id_a,
    b.parentrowid AS id_b,

    EDIT_DISTANCE(a.nm, b.nm) AS d_nm,
    EDIT_DISTANCE(a.mm, b.mm) AS d_mm,

    -- tokens
    SPLIT(a.nm, ' ') AS arr_nm_a,
    SPLIT(b.nm, ' ') AS arr_nm_b,
    SPLIT(a.mm, ' ') AS arr_mm_a,
    SPLIT(b.mm, ' ') AS arr_mm_b
  FROM blocked a
  JOIN blocked b
    ON a.sx_nm = b.sx_nm AND a.sx_mm = b.sx_mm
   AND a.parentrowid < b.parentrowid             -- evita espelho
),

-- 3) MÉTRICAS de contenção (tokens_inter / tokens_menor)
scored AS (
  SELECT *,
    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_nm_a) x
                             INNER JOIN UNNEST(arr_nm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_nm_a), ARRAY_LENGTH(arr_nm_b))         AS cont_nm,

    ARRAY_LENGTH(
      (SELECT ARRAY_AGG(x) FROM UNNEST(arr_mm_a) x
                             INNER JOIN UNNEST(arr_mm_b) y ON x=y)
    ) / LEAST(ARRAY_LENGTH(arr_mm_a), ARRAY_LENGTH(arr_mm_b))         AS cont_mm
  FROM pairs
),

-- 4) REGRA DE MATCH
dupes AS (
  SELECT id_a, id_b
  FROM scored
  WHERE
        (d_nm <= 2 OR cont_nm >= 0.8)
    AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 5) CLUSTER  ➜ menor parentrowid do grupo
cluster_map AS (
  SELECT id_a AS parentrowid, LEAST(id_a, MIN(id_b)) AS seed
  FROM dupes
  GROUP BY id_a

  UNION ALL

  SELECT parentrowid, parentrowid
  FROM base                                   -- singletons
)

SELECT
  b.*,
  MIN(seed) OVER (PARTITION BY seed) AS cluster_id,
  COUNT(*)  OVER (PARTITION BY seed) AS cluster_size
FROM base b
LEFT JOIN cluster_map USING (parentrowid);


[0m17:23:31.523211 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:23:32.423690 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:0f5d0ed7-d289-4446-85ed-5dcc318f893d&page=queryresults
[0m17:23:33.030033 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd385a2cc-f69d-4baa-8c45-63b66dd37874', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff72c3c4700>]}
[0m17:23:33.031359 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names_cluster . [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m17:23:33.032385 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m17:23:33.034923 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:23:33.082865 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:23:33.083566 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m17:23:33.084002 [info ] [MainThread]: 
[0m17:23:33.084428 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.15 seconds (3.15s).
[0m17:23:33.085530 [debug] [MainThread]: Command end result
[0m17:23:33.120676 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m17:23:33.123130 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m17:23:33.132646 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m17:23:33.133260 [info ] [MainThread]: 
[0m17:23:33.133853 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:23:33.134313 [info ] [MainThread]: 
[0m17:23:33.134882 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:23:33.135640 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.263472, "process_in_blocks": "0", "process_kernel_time": 0.742281, "process_mem_max_rss": "400624", "process_out_blocks": "3232", "process_user_time": 7.206929}
[0m17:23:33.136306 [debug] [MainThread]: Command `dbt run` succeeded at 17:23:33.136175 after 8.26 seconds
[0m17:23:33.136853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff746f7d4b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff74616bd30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff746e4fb50>]}
[0m17:23:33.137436 [debug] [MainThread]: Flushing usage events
[0m17:23:33.703303 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m17:34:52.595388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2720645390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f271f82fa90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f271f82fa30>]}


============================== 17:34:52.599207 | c5d3a252-81d7-4a63-acb1-3e01d5122e34 ==============================
[0m17:34:52.599207 [info ] [MainThread]: Running with dbt=1.9.4
[0m17:34:52.599959 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'queries', 'log_path': 'queries/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:34:56.213669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f271fa32c20>]}
[0m17:34:56.327626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f271fd2b490>]}
[0m17:34:56.328816 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m17:34:56.598204 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m17:34:56.792709 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:34:56.793780 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m17:34:57.288005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26ff874130>]}
[0m17:34:57.409955 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m17:34:57.412552 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m17:34:57.425452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26ff875f90>]}
[0m17:34:57.426241 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m17:34:57.426822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26ff8757e0>]}
[0m17:34:57.428713 [info ] [MainThread]: 
[0m17:34:57.429278 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:34:57.429850 [info ] [MainThread]: 
[0m17:34:57.430642 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:34:57.432608 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m17:34:57.433675 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:34:58.159744 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m17:34:58.160586 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:34:58.765328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f26ff8757e0>]}
[0m17:34:58.766398 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:34:58.814393 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m17:34:58.815476 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.stg_repeat_names_cluster ..... [RUN]
[0m17:34:58.816218 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m17:34:58.816699 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m17:34:58.828081 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m17:34:58.829112 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m17:34:58.884525 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m17:34:58.885801 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
      
    
    

    OPTIONS()
    as (
      

-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm
    FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) OVER (PARTITION BY parentrowid) AS cluster_seed
    FROM graph
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.parentrowid,
        b.nm,
        b.mm,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    parentrowid,
    nm,
    mm,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
    );
  
[0m17:34:58.886575 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:34:59.855246 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:632c75c9-af5f-417d-a7eb-c773eacb7d5b&page=queryresults
[0m17:35:45.083447 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c5d3a252-81d7-4a63-acb1-3e01d5122e34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2705ac06d0>]}
[0m17:35:45.084522 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.stg_repeat_names_cluster  [[32mCREATE TABLE (18.3m rows, 22.9 MiB processed)[0m in 46.27s]
[0m17:35:45.085318 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m17:35:45.087007 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:35:45.133359 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:35:45.134127 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m17:35:45.134758 [info ] [MainThread]: 
[0m17:35:45.135539 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 47.70 seconds (47.70s).
[0m17:35:45.136626 [debug] [MainThread]: Command end result
[0m17:35:45.169517 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m17:35:45.171614 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m17:35:45.188004 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m17:35:45.188590 [info ] [MainThread]: 
[0m17:35:45.189130 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:35:45.189517 [info ] [MainThread]: 
[0m17:35:45.189943 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:35:45.190713 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 52.700253, "process_in_blocks": "8", "process_kernel_time": 0.722727, "process_mem_max_rss": "399076", "process_out_blocks": "3264", "process_user_time": 7.119389}
[0m17:35:45.191379 [debug] [MainThread]: Command `dbt run` succeeded at 17:35:45.191257 after 52.70 seconds
[0m17:35:45.191858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2720645390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f271fd2b490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f2720711240>]}
[0m17:35:45.192337 [debug] [MainThread]: Flushing usage events
[0m17:35:45.746280 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:16:55.511714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd371853f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd36373b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd36373ac0>]}


============================== 21:16:55.518113 | daaca3b6-0b75-4e42-8c41-0b313c50d900 ==============================
[0m21:16:55.518113 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:16:55.519026 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'warn_error': 'None', 'log_path': 'queries/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:17:00.675176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd38d74cd0>]}
[0m21:17:00.777386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd1c5f6740>]}
[0m21:17:00.786684 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:17:01.066007 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:17:01.300638 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:17:01.301505 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:17:01.852968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd171dc220>]}
[0m21:17:02.009877 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:17:02.012623 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:17:02.038736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd16d77cd0>]}
[0m21:17:02.039801 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m21:17:02.040510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd16f18820>]}
[0m21:17:02.042800 [info ] [MainThread]: 
[0m21:17:02.043398 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:17:02.043994 [info ] [MainThread]: 
[0m21:17:02.044824 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:17:02.046681 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:17:02.047629 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:17:03.126683 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:17:03.127566 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:17:03.773273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd16ce8070>]}
[0m21:17:03.774129 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:17:03.825105 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:17:03.826252 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:17:03.827095 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:17:03.827842 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:17:03.840475 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:17:03.841477 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:17:03.884029 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:17:03.885326 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
  WHERE = '2025'
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m21:17:03.886074 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:17:04.559523 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:05c791ef-39cd-4e75-9699-4f65fdf3a914&page=queryresults
[0m21:17:04.561160 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:05c791ef-39cd-4e75-9699-4f65fdf3a914&page=queryresults
[0m21:17:04.573226 [debug] [Thread-1 (]: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected "=" at [15:9]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:17:04.576940 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'daaca3b6-0b75-4e42-8c41-0b313c50d900', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd37463580>]}
[0m21:17:04.578792 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model dashboard_arcgis_dev.stg_repeat_names ..... [[31mERROR[0m in 0.75s]
[0m21:17:04.579933 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:17:04.581039 [debug] [Thread-5 (]: Marking all children of 'model.queries.stg_repeat_names' to be skipped because of status 'error'.  Reason: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected "=" at [15:9]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql.
[0m21:17:04.583937 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:17:04.630403 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:17:04.631124 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:17:04.631600 [info ] [MainThread]: 
[0m21:17:04.632073 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.59 seconds (2.59s).
[0m21:17:04.632941 [debug] [MainThread]: Command end result
[0m21:17:04.663208 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:17:04.665443 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:17:04.674520 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:17:04.675130 [info ] [MainThread]: 
[0m21:17:04.675637 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m21:17:04.676080 [info ] [MainThread]: 
[0m21:17:04.676568 [error] [MainThread]:   Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Syntax error: Unexpected "=" at [15:9]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:17:04.676969 [info ] [MainThread]: 
[0m21:17:04.677386 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:17:04.686439 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 9.274599, "process_in_blocks": "386600", "process_kernel_time": 0.985897, "process_mem_max_rss": "395852", "process_out_blocks": "3248", "process_user_time": 7.074266}
[0m21:17:04.687156 [debug] [MainThread]: Command `dbt run` failed at 21:17:04.687010 after 9.28 seconds
[0m21:17:04.687701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd371853f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd16c91660>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fcd37054910>]}
[0m21:17:04.688194 [debug] [MainThread]: Flushing usage events
[0m21:17:05.287116 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:17:55.943828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58ddb5d420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58dcd47b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58dcd47af0>]}


============================== 21:17:55.946995 | b60f8f0c-acd4-474d-82e8-02558b4efe55 ==============================
[0m21:17:55.946995 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:17:55.947623 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'queries/logs', 'profiles_dir': 'queries', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:17:59.537156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58dcd07160>]}
[0m21:17:59.644503 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58bdded600>]}
[0m21:17:59.645441 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:17:59.917697 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:18:00.099920 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:18:00.100799 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:18:00.596230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58bd64b700>]}
[0m21:18:00.710761 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:18:00.712875 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:18:00.724980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58bd8f8d90>]}
[0m21:18:00.725728 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m21:18:00.726191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58bd8f8c70>]}
[0m21:18:00.727800 [info ] [MainThread]: 
[0m21:18:00.728322 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:18:00.728759 [info ] [MainThread]: 
[0m21:18:00.729387 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:18:00.731022 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:18:00.732230 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:18:01.523823 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:18:01.525070 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:18:02.545764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58dcce0d90>]}
[0m21:18:02.546679 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:18:02.594617 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:18:02.595972 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:18:02.596988 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:18:02.597824 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:18:02.614569 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:18:02.615507 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:18:02.657112 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:18:02.658293 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m21:18:02.659077 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:18:03.663498 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:a1df02c4-ae6f-497b-9cff-192ebdc5241a&page=queryresults
[0m21:18:03.939479 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:a1df02c4-ae6f-497b-9cff-192ebdc5241a&page=queryresults
[0m21:18:03.945450 [debug] [Thread-1 (]: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Unrecognized name: ano_num_data_abordagem at [78:3]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:18:03.948702 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b60f8f0c-acd4-474d-82e8-02558b4efe55', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58dde39540>]}
[0m21:18:03.949835 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model dashboard_arcgis_dev.stg_repeat_names ..... [[31mERROR[0m in 1.35s]
[0m21:18:03.950829 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:18:03.952072 [debug] [Thread-5 (]: Marking all children of 'model.queries.stg_repeat_names' to be skipped because of status 'error'.  Reason: Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Unrecognized name: ano_num_data_abordagem at [78:3]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql.
[0m21:18:03.962752 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:18:04.031771 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:18:04.032371 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:18:04.032835 [info ] [MainThread]: 
[0m21:18:04.033284 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.30 seconds (3.30s).
[0m21:18:04.034245 [debug] [MainThread]: Command end result
[0m21:18:04.066732 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:18:04.068763 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:18:04.077446 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:18:04.078041 [info ] [MainThread]: 
[0m21:18:04.078567 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m21:18:04.079049 [info ] [MainThread]: 
[0m21:18:04.079743 [error] [MainThread]:   Database Error in model stg_repeat_names (models/dashboard_arcgis/staging/stg_repeat_names.sql)
  Unrecognized name: ano_num_data_abordagem at [78:3]
  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:18:04.080205 [info ] [MainThread]: 
[0m21:18:04.080762 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:18:04.081417 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 8.231492, "process_in_blocks": "0", "process_kernel_time": 0.76827, "process_mem_max_rss": "395876", "process_out_blocks": "3248", "process_user_time": 6.823204}
[0m21:18:04.081972 [debug] [MainThread]: Command `dbt run` failed at 21:18:04.081864 after 8.23 seconds
[0m21:18:04.082460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58ddb5d420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58ddc00df0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f58bcedf700>]}
[0m21:18:04.082928 [debug] [MainThread]: Flushing usage events
[0m21:18:04.620970 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:19:07.669572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2f439420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2e627b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2e627af0>]}


============================== 21:19:07.672962 | 3d5aef0a-0f9a-41e6-96a7-5fd51a48f249 ==============================
[0m21:19:07.672962 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:19:07.673790 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'queries/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:19:11.291355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2e5e3160>]}
[0m21:19:11.407818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b0f725600>]}
[0m21:19:11.409135 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:19:11.691243 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:19:11.891945 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:19:11.892906 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m21:19:12.409473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b0ef7b700>]}
[0m21:19:12.532015 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:19:12.534108 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:19:12.546950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b0f22cd90>]}
[0m21:19:12.547915 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m21:19:12.548576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b0f22cc70>]}
[0m21:19:12.550443 [info ] [MainThread]: 
[0m21:19:12.550976 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:19:12.551378 [info ] [MainThread]: 
[0m21:19:12.552063 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:19:12.553796 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:19:12.554981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:13.363162 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:19:13.363956 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:14.029143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2e5c8b80>]}
[0m21:19:14.030034 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:19:14.082808 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m21:19:14.083836 [info ] [Thread-1 (]: 1 of 1 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m21:19:14.084687 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names)
[0m21:19:14.085383 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m21:19:14.097723 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m21:19:14.098715 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m21:19:14.139723 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m21:19:14.140873 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m21:19:14.141646 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:19:15.003224 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:eaec0e2d-0447-4c88-972a-0fd3fba90886&page=queryresults
[0m21:19:15.586825 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d5aef0a-0f9a-41e6-96a7-5fd51a48f249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b0eff2d40>]}
[0m21:19:15.587903 [info ] [Thread-1 (]: 1 of 1 OK created sql view model dashboard_arcgis_dev.stg_repeat_names ......... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m21:19:15.588822 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m21:19:15.590892 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:19:15.636594 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:19:15.637265 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names' was properly closed.
[0m21:19:15.637742 [info ] [MainThread]: 
[0m21:19:15.638492 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.09 seconds (3.09s).
[0m21:19:15.639407 [debug] [MainThread]: Command end result
[0m21:19:15.670399 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:19:15.672374 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:19:15.681332 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:19:15.686148 [info ] [MainThread]: 
[0m21:19:15.686935 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:19:15.687484 [info ] [MainThread]: 
[0m21:19:15.688032 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:19:15.688822 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.118737, "process_in_blocks": "1640", "process_kernel_time": 0.772234, "process_mem_max_rss": "400292", "process_out_blocks": "3240", "process_user_time": 6.938233}
[0m21:19:15.689385 [debug] [MainThread]: Command `dbt run` succeeded at 21:19:15.689262 after 8.12 seconds
[0m21:19:15.689890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2f439420>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2e5e3160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5b2f4dcdf0>]}
[0m21:19:15.690402 [debug] [MainThread]: Flushing usage events
[0m21:19:16.293383 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m21:20:38.806758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeaa9693c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faea9b57b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faea9b57af0>]}


============================== 21:20:38.810089 | 98549210-f2c8-4cac-a22c-e4a7e466cd51 ==============================
[0m21:20:38.810089 [info ] [MainThread]: Running with dbt=1.9.4
[0m21:20:38.810852 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'version_check': 'True', 'log_path': 'queries/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:20:42.364167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeaa83a710>]}
[0m21:20:42.472497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fae8aa2b700>]}
[0m21:20:42.473480 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m21:20:42.739062 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m21:20:42.917918 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:20:42.918921 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m21:20:43.393950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fae89d68130>]}
[0m21:20:43.518482 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:20:43.520590 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:20:43.533477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fae89d69f60>]}
[0m21:20:43.534221 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m21:20:43.534973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeab7a09d0>]}
[0m21:20:43.536635 [info ] [MainThread]: 
[0m21:20:43.537211 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:20:43.537705 [info ] [MainThread]: 
[0m21:20:43.538442 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:20:43.539505 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m21:20:43.539978 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:44.276986 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m21:20:44.277957 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:20:44.933205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeac1e7f10>]}
[0m21:20:44.933935 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:20:44.980488 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m21:20:44.981328 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.stg_repeat_names_cluster ..... [RUN]
[0m21:20:44.982247 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m21:20:44.982728 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m21:20:44.993941 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m21:20:44.995008 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m21:20:45.016818 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:45.686108 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m21:20:45.687904 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
      
    
    

    OPTIONS()
    as (
      

-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) OVER (PARTITION BY parentrowid) AS cluster_seed
    FROM graph
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
    );
  
[0m21:20:46.325856 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:38fb1f10-982d-4a78-b32a-a9519dbf1432&page=queryresults
[0m21:21:27.470141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98549210-f2c8-4cac-a22c-e4a7e466cd51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fae8fdb4c70>]}
[0m21:21:27.471189 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.stg_repeat_names_cluster  [[32mCREATE TABLE (18.3m rows, 24.4 MiB processed)[0m in 42.49s]
[0m21:21:27.471992 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m21:21:27.473700 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:21:27.516771 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:27.517369 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m21:21:27.517986 [info ] [MainThread]: 
[0m21:21:27.518622 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 43.98 seconds (43.98s).
[0m21:21:27.519492 [debug] [MainThread]: Command end result
[0m21:21:27.552205 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m21:21:27.554828 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m21:21:27.564701 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m21:21:27.565287 [info ] [MainThread]: 
[0m21:21:27.565904 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:21:27.566306 [info ] [MainThread]: 
[0m21:21:27.566773 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:21:27.567437 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 48.865696, "process_in_blocks": "0", "process_kernel_time": 0.801472, "process_mem_max_rss": "402924", "process_out_blocks": "3256", "process_user_time": 6.856792}
[0m21:21:27.568000 [debug] [MainThread]: Command `dbt run` succeeded at 21:21:27.567882 after 48.87 seconds
[0m21:21:27.568459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeaa9693c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faeaa83a710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fae8a58fc40>]}
[0m21:21:27.568927 [debug] [MainThread]: Flushing usage events
[0m21:21:28.123201 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:20:32.520971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08b255480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08a443bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08a443b50>]}


============================== 22:20:32.527001 | 0c5b3fd5-9c6e-473c-9dda-a023225e1056 ==============================
[0m22:20:32.527001 [info ] [MainThread]: Running with dbt=1.9.4
[0m22:20:32.528122 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'queries/logs', 'version_check': 'True', 'profiles_dir': 'queries', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'send_anonymous_usage_stats': 'True'}
[0m22:20:38.500961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08cdbccd0>]}
[0m22:20:38.650173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb06b56e800>]}
[0m22:20:38.651699 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m22:20:38.994269 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m22:20:39.326647 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:20:39.327646 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m22:20:39.885040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb06aef8130>]}
[0m22:20:40.006310 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m22:20:40.009170 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m22:20:40.054972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb06aef80d0>]}
[0m22:20:40.055740 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m22:20:40.056189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08c0002b0>]}
[0m22:20:40.058181 [info ] [MainThread]: 
[0m22:20:40.058842 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:20:40.059371 [info ] [MainThread]: 
[0m22:20:40.060076 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:20:40.061465 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m22:20:40.062025 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:20:41.057600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m22:20:41.059123 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:20:41.741400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb06aef9a80>]}
[0m22:20:41.742516 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:20:41.798195 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m22:20:41.799735 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.stg_repeat_names_cluster ..... [RUN]
[0m22:20:41.800793 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m22:20:41.801318 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m22:20:41.814567 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m22:20:41.815877 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m22:20:41.871757 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m22:20:41.873057 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
      
    
    

    OPTIONS()
    as (
      

-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
    );
  
[0m22:20:41.873957 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:20:43.071253 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:610cdb1e-b3e7-476e-be50-63c2512190b8&page=queryresults
[0m22:21:20.472622 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c5b3fd5-9c6e-473c-9dda-a023225e1056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb0706b87f0>]}
[0m22:21:20.473675 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.stg_repeat_names_cluster  [[32mCREATE TABLE (261.6k rows, 24.4 MiB processed)[0m in 38.67s]
[0m22:21:20.474513 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m22:21:20.475950 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:21:20.533373 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:21:20.534193 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m22:21:20.534879 [info ] [MainThread]: 
[0m22:21:20.535496 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 40.48 seconds (40.48s).
[0m22:21:20.536687 [debug] [MainThread]: Command end result
[0m22:21:20.569991 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m22:21:20.572019 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m22:21:20.596822 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m22:21:20.597588 [info ] [MainThread]: 
[0m22:21:20.598303 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:21:20.598895 [info ] [MainThread]: 
[0m22:21:20.599492 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:21:20.600440 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 48.190525, "process_in_blocks": "410368", "process_kernel_time": 1.408479, "process_mem_max_rss": "399760", "process_out_blocks": "3256", "process_user_time": 7.476841}
[0m22:21:20.601213 [debug] [MainThread]: Command `dbt run` succeeded at 22:21:20.601059 after 48.19 seconds
[0m22:21:20.601897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08b255480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb08cdbccd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb069e57670>]}
[0m22:21:20.602676 [debug] [MainThread]: Flushing usage events
[0m22:21:21.190011 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m20:02:56.890200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a49f613f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a4914bb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a4914bac0>]}


============================== 20:02:56.895822 | de290fe9-8b8c-41fe-a9ea-4a31fc452c93 ==============================
[0m20:02:56.895822 [info ] [MainThread]: Running with dbt=1.9.4
[0m20:02:56.896743 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'queries', 'debug': 'False', 'warn_error': 'None', 'log_path': 'queries/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:03:02.562197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a2a0cee90>]}
[0m20:03:02.664108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a2a26fc40>]}
[0m20:03:02.665145 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m20:03:02.974096 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m20:03:03.206381 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:03:03.207377 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:03:03.268826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a29bf3e50>]}
[0m20:03:03.401504 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m20:03:03.405020 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m20:03:03.431677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a29bf8c70>]}
[0m20:03:03.432657 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m20:03:03.433219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a29bf1090>]}
[0m20:03:03.435133 [info ] [MainThread]: 
[0m20:03:03.435711 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:03:03.436222 [info ] [MainThread]: 
[0m20:03:03.437051 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:03:03.438939 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m20:03:03.440045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:03:04.255426 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m20:03:04.256625 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:03:04.884917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a490e4430>]}
[0m20:03:04.885637 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:03:04.936262 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m20:03:04.937464 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.stg_repeat_names_cluster ..... [RUN]
[0m20:03:04.938544 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.stg_repeat_names_cluster)
[0m20:03:04.939023 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m20:03:04.954390 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m20:03:04.959596 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m20:03:04.979782 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:03:05.646444 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m20:03:05.647769 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
      
    
    

    OPTIONS()
    as (
      

-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
    );
  
[0m20:03:06.407290 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:386ce386-d2c6-4d90-a43d-dc838ab8a28d&page=queryresults
[0m20:03:49.240732 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de290fe9-8b8c-41fe-a9ea-4a31fc452c93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a2f4206d0>]}
[0m20:03:49.241960 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.stg_repeat_names_cluster  [[32mCREATE TABLE (262.1k rows, 24.5 MiB processed)[0m in 44.30s]
[0m20:03:49.243053 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m20:03:49.245303 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:03:49.292308 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:03:49.293166 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m20:03:49.293867 [info ] [MainThread]: 
[0m20:03:49.294818 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 45.86 seconds (45.86s).
[0m20:03:49.296124 [debug] [MainThread]: Command end result
[0m20:03:49.332653 [debug] [MainThread]: Wrote artifact WritableManifest to queries/target/manifest.json
[0m20:03:49.334950 [debug] [MainThread]: Wrote artifact SemanticManifest to queries/target/semantic_manifest.json
[0m20:03:49.343596 [debug] [MainThread]: Wrote artifact RunExecutionResult to queries/target/run_results.json
[0m20:03:49.344177 [info ] [MainThread]: 
[0m20:03:49.344840 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:03:49.345331 [info ] [MainThread]: 
[0m20:03:49.345866 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:03:49.346677 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 52.56469, "process_in_blocks": "415984", "process_kernel_time": 1.120152, "process_mem_max_rss": "393664", "process_out_blocks": "2208", "process_user_time": 6.683967}
[0m20:03:49.347368 [debug] [MainThread]: Command `dbt run` succeeded at 20:03:49.347220 after 52.57 seconds
[0m20:03:49.347892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a49f613f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a4a005cf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4a29ba2620>]}
[0m20:03:49.348430 [debug] [MainThread]: Flushing usage events
[0m20:03:49.900582 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:38:22.620311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x738068f6c550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7380681eb6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7380681eb670>]}


============================== 13:38:22.668557 | b80ed6a0-afa9-4c7c-a1f6-6c7512cd3895 ==============================
[0m13:38:22.668557 [info ] [MainThread]: Running with dbt=1.9.4
[0m13:38:22.669288 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'debug': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m13:38:22.719924 [info ] [MainThread]: dbt version: 1.9.4
[0m13:38:22.720576 [info ] [MainThread]: python version: 3.10.17
[0m13:38:22.721124 [info ] [MainThread]: python path: /workspaces/pipeline_arcgis/.venv/bin/python
[0m13:38:22.721610 [info ] [MainThread]: os info: Linux-6.8.0-1027-azure-x86_64-with-glibc2.36
[0m13:38:35.721390 [info ] [MainThread]: Using profiles dir at /workspaces/pipeline_arcgis/queries
[0m13:38:35.722987 [info ] [MainThread]: Using profiles.yml file at /workspaces/pipeline_arcgis/queries/profiles.yml
[0m13:38:35.723934 [info ] [MainThread]: Using dbt_project.yml file at /workspaces/pipeline_arcgis/queries/dbt_project.yml
[0m13:38:35.724764 [info ] [MainThread]: adapter type: bigquery
[0m13:38:35.725705 [info ] [MainThread]: adapter version: 1.9.2
[0m13:38:35.869435 [info ] [MainThread]: Configuration:
[0m13:38:35.870676 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m13:38:35.871498 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m13:38:35.872262 [info ] [MainThread]: Required dependencies:
[0m13:38:35.873071 [debug] [MainThread]: Executing "git --help"
[0m13:38:35.879483 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone      Clone a repository into a new directory\n   init       Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add        Add file contents to the index\n   mv         Move or rename a file, a directory, or a symlink\n   restore    Restore working tree files\n   rm         Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect     Use binary search to find the commit that introduced a bug\n   diff       Show changes between commits, commit and working tree, etc\n   grep       Print lines matching a pattern\n   log        Show commit logs\n   show       Show various types of objects\n   status     Show the working tree status\n\ngrow, mark and tweak your common history\n   backfill   Download missing objects in a partial clone\n   branch     List, create, or delete branches\n   commit     Record changes to the repository\n   merge      Join two or more development histories together\n   rebase     Reapply commits on top of another base tip\n   reset      Reset current HEAD to the specified state\n   switch     Switch branches\n   tag        Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch      Download objects and refs from another repository\n   pull       Fetch from and integrate with another repository or a local branch\n   push       Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m13:38:35.880381 [debug] [MainThread]: STDERR: "b''"
[0m13:38:35.881102 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m13:38:35.882018 [info ] [MainThread]: Connection:
[0m13:38:35.882879 [info ] [MainThread]:   method: service-account
[0m13:38:35.883688 [info ] [MainThread]:   database: rj-smas-dev
[0m13:38:35.884531 [info ] [MainThread]:   execution_project: rj-smas-dev
[0m13:38:35.885302 [info ] [MainThread]:   schema: dashboard_arcgis_dev
[0m13:38:35.885924 [info ] [MainThread]:   location: US
[0m13:38:35.886528 [info ] [MainThread]:   priority: None
[0m13:38:35.887576 [info ] [MainThread]:   maximum_bytes_billed: None
[0m13:38:35.888566 [info ] [MainThread]:   impersonate_service_account: None
[0m13:38:35.889436 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m13:38:35.890267 [info ] [MainThread]:   job_retries: 1
[0m13:38:35.891111 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m13:38:35.891896 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m13:38:35.892768 [info ] [MainThread]:   timeout_seconds: 300
[0m13:38:35.893733 [info ] [MainThread]:   client_id: None
[0m13:38:35.894583 [info ] [MainThread]:   token_uri: None
[0m13:38:35.895425 [info ] [MainThread]:   compute_region: None
[0m13:38:35.896251 [info ] [MainThread]:   dataproc_cluster_name: None
[0m13:38:35.897075 [info ] [MainThread]:   gcs_bucket: None
[0m13:38:35.897894 [info ] [MainThread]:   dataproc_batch: None
[0m13:38:35.898957 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m13:38:36.310514 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m13:38:36.311122 [debug] [MainThread]: On debug: select 1 as id
[0m13:38:36.311610 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:38:36.785064 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:06d6ff02-d3dd-442d-8988-dc7c3be18b3c&page=queryresults
[0m13:38:37.308799 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m13:38:37.309509 [info ] [MainThread]: [32mAll checks passed![0m
[0m13:38:37.310312 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 14.763074, "process_in_blocks": "384976", "process_kernel_time": 1.510163, "process_mem_max_rss": "385180", "process_out_blocks": "166416", "process_user_time": 13.044572}
[0m13:38:37.310910 [debug] [MainThread]: Command `dbt debug` succeeded at 13:38:37.310763 after 14.76 seconds
[0m13:38:37.311340 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m13:38:37.311849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x738068f6c550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7380681ea740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73804e5efd90>]}
[0m13:38:37.312491 [debug] [MainThread]: Flushing usage events
[0m13:38:37.377287 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:42:09.094485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a89672be290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a8966259630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a89662595d0>]}


============================== 13:42:09.098053 | 42462c33-cc54-49cf-ad4f-b891e52d246b ==============================
[0m13:42:09.098053 [info ] [MainThread]: Running with dbt=1.9.4
[0m13:42:09.098858 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:42:12.464412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894c2a99c0>]}
[0m13:42:12.547512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894c2a9b70>]}
[0m13:42:12.548222 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m13:42:12.952293 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m13:42:13.057062 [info ] [MainThread]: Unable to do partial parsing because config vars, config profile, or config target have changed
[0m13:42:13.057683 [debug] [MainThread]: previous checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, current checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25
[0m13:42:13.058205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a89666d0af0>]}
[0m13:42:14.548897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b75e410>]}
[0m13:42:14.641053 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m13:42:14.642919 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m13:42:14.675733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b472ad0>]}
[0m13:42:14.676432 [info ] [MainThread]: Found 4 models, 2 sources, 494 macros
[0m13:42:14.676993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b472860>]}
[0m13:42:14.678849 [info ] [MainThread]: 
[0m13:42:14.679359 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:42:14.679867 [info ] [MainThread]: 
[0m13:42:14.680586 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:42:14.687285 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m13:42:14.687849 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:42:15.152521 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m13:42:15.153164 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:42:15.444114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a896881fdf0>]}
[0m13:42:15.444785 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:42:15.490214 [debug] [Thread-1 (]: Began running node model.queries.abordagem_ficha
[0m13:42:15.491675 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m13:42:15.491201 [info ] [Thread-1 (]: 1 of 4 START sql table model dashboard_arcgis_dev.abordagem_ficha .............. [RUN]
[0m13:42:15.492544 [info ] [Thread-2 (]: 2 of 4 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m13:42:15.493500 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_ficha)
[0m13:42:15.494575 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m13:42:15.495288 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_ficha
[0m13:42:15.495851 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m13:42:15.506430 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_ficha"
[0m13:42:15.512755 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_ficha
[0m13:42:15.520350 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m13:42:15.556879 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m13:42:15.560587 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_ficha"
[0m13:42:15.563409 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m13:42:15.564725 [debug] [Thread-1 (]: On model.queries.abordagem_ficha: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_ficha"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_ficha`
      
    
    

    OPTIONS()
    as (
      -- models/dashboard_arcgis/abordagem_ficha.sql

SELECT 
  uniquerowid,
  unidade_calculo,
  nome_usuario,
  SAFE.PARSE_DATE('%d/%m/%Y', data_nascimento) AS data_nascimento,
  cpf,
  nome_mae,
  filtro_ano_ultima_abordagem,
  filtro_data_abordagem,
  IFNULL(excluir_ficha, 'Não') AS excluir_ficha,  
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_ficha_raw`
    );
  
[0m13:42:15.566158 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m13:42:15.567968 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:15.568609 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m13:42:16.175494 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:6307eae5-ff14-4d71-b32c-5f455daadec9&page=queryresults
[0m13:42:16.275184 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:4d4a206f-74f3-4699-bd47-181becdd5a01&page=queryresults
[0m13:42:20.369183 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a895154e9e0>]}
[0m13:42:20.370279 [info ] [Thread-1 (]: 1 of 4 OK created sql table model dashboard_arcgis_dev.abordagem_ficha ......... [[32mCREATE TABLE (188.7k rows, 32.0 MiB processed)[0m in 4.87s]
[0m13:42:20.371219 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_ficha
[0m13:42:20.371764 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names
[0m13:42:20.372470 [info ] [Thread-1 (]: 3 of 4 START sql view model dashboard_arcgis_dev.stg_repeat_names .............. [RUN]
[0m13:42:20.373116 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_ficha, now model.queries.stg_repeat_names)
[0m13:42:20.373619 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names
[0m13:42:20.377924 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names"
[0m13:42:20.378917 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names
[0m13:42:20.402010 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names"
[0m13:42:20.403120 [debug] [Thread-1 (]: On model.queries.stg_repeat_names: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
  OPTIONS()
  as 

WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered;


[0m13:42:20.404192 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:20.867463 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:c42602d5-3ff3-4718-a2bc-bc9b9741ef43&page=queryresults
[0m13:42:21.408430 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a89488d6ce0>]}
[0m13:42:21.409301 [info ] [Thread-1 (]: 3 of 4 OK created sql view model dashboard_arcgis_dev.stg_repeat_names ......... [[32mCREATE VIEW (0 processed)[0m in 1.04s]
[0m13:42:21.410125 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names
[0m13:42:21.410902 [debug] [Thread-1 (]: Began running node model.queries.stg_repeat_names_cluster
[0m13:42:21.411496 [info ] [Thread-1 (]: 4 of 4 START sql table model dashboard_arcgis_dev.stg_repeat_names_cluster ..... [RUN]
[0m13:42:21.412126 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.stg_repeat_names, now model.queries.stg_repeat_names_cluster)
[0m13:42:21.412617 [debug] [Thread-1 (]: Began compiling node model.queries.stg_repeat_names_cluster
[0m13:42:21.418207 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.stg_repeat_names_cluster"
[0m13:42:21.419032 [debug] [Thread-1 (]: Began executing node model.queries.stg_repeat_names_cluster
[0m13:42:21.421986 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.stg_repeat_names_cluster"
[0m13:42:21.422984 [debug] [Thread-1 (]: On model.queries.stg_repeat_names_cluster: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.stg_repeat_names_cluster"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`
      
    
    

    OPTIONS()
    as (
      

-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
    );
  
[0m13:42:21.423660 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:42:22.408110 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:db3e75cc-b8c8-42f5-8532-d4547c432bc2&page=queryresults
[0m13:42:27.576093 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b471780>]}
[0m13:42:27.577042 [info ] [Thread-2 (]: 2 of 4 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 307.9 MiB processed)[0m in 12.08s]
[0m13:42:27.577905 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m13:43:08.798167 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42462c33-cc54-49cf-ad4f-b891e52d246b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b5d7880>]}
[0m13:43:08.799114 [info ] [Thread-1 (]: 4 of 4 OK created sql table model dashboard_arcgis_dev.stg_repeat_names_cluster  [[32mCREATE TABLE (266.1k rows, 35.0 MiB processed)[0m in 47.39s]
[0m13:43:08.799972 [debug] [Thread-1 (]: Finished running node model.queries.stg_repeat_names_cluster
[0m13:43:08.801285 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:43:08.843559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:43:08.843984 [debug] [MainThread]: Connection 'model.queries.stg_repeat_names_cluster' was properly closed.
[0m13:43:08.844400 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m13:43:08.844942 [info ] [MainThread]: 
[0m13:43:08.845480 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 54.16 seconds (54.16s).
[0m13:43:08.846807 [debug] [MainThread]: Command end result
[0m13:43:08.876642 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m13:43:08.878635 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m13:43:08.885993 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m13:43:08.886434 [info ] [MainThread]: 
[0m13:43:08.887059 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:43:08.887540 [info ] [MainThread]: 
[0m13:43:08.888108 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m13:43:08.888850 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 59.865612, "process_in_blocks": "170920", "process_kernel_time": 0.880543, "process_mem_max_rss": "400432", "process_out_blocks": "3648", "process_user_time": 6.84045}
[0m13:43:08.889425 [debug] [MainThread]: Command `dbt run` succeeded at 13:43:08.889305 after 59.87 seconds
[0m13:43:08.889910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a89672be290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a894b74b580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a8967fb6770>]}
[0m13:43:08.890407 [debug] [MainThread]: Flushing usage events
[0m13:43:09.938997 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:48:04.915361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e7439be260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e74295d630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e74295d5d0>]}


============================== 13:48:04.918932 | d09712e5-a6e0-4204-9c2d-26a0dd655ec6 ==============================
[0m13:48:04.918932 [info ] [MainThread]: Running with dbt=1.9.4
[0m13:48:04.919682 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'debug': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select abordagem_repeat', 'send_anonymous_usage_stats': 'True'}
[0m13:48:08.187522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e7289519c0>]}
[0m13:48:08.269932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e742e21ba0>]}
[0m13:48:08.270675 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m13:48:08.665549 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m13:48:08.831922 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 1 files changed.
[0m13:48:08.832609 [debug] [MainThread]: Partial parsing: deleted file: queries://models/dashboard_arcgis/abordagem_ficha.sql
[0m13:48:08.833214 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/abordagem_repeat.sql
[0m13:48:09.184989 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'abordagem_ficha' in the 'models' section of file 'models/dashboard_arcgis/schema.yml'
[0m13:48:09.263907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e727e8b3d0>]}
[0m13:48:09.352371 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m13:48:09.354186 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m13:48:09.374330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e727dbbf10>]}
[0m13:48:09.374985 [info ] [MainThread]: Found 3 models, 2 sources, 494 macros
[0m13:48:09.375505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e727dbbeb0>]}
[0m13:48:09.376958 [info ] [MainThread]: 
[0m13:48:09.377466 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:48:09.377977 [info ] [MainThread]: 
[0m13:48:09.378742 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:48:09.379781 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m13:48:09.380361 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:48:09.927598 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m13:48:09.928284 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:48:10.249065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e74291db40>]}
[0m13:48:10.249720 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:48:10.294309 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m13:48:10.295036 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m13:48:10.295687 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m13:48:10.296219 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m13:48:10.307624 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m13:48:10.308409 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m13:48:10.324283 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:48:10.650018 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m13:48:10.651723 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m13:48:11.139622 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:806ac372-b721-43a6-a1a5-c7825a8f978f&page=queryresults
[0m13:48:22.720719 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd09712e5-a6e0-4204-9c2d-26a0dd655ec6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e727d979d0>]}
[0m13:48:22.721989 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 12.42s]
[0m13:48:22.723269 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m13:48:22.725068 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:48:22.768950 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:48:22.769429 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m13:48:22.769928 [info ] [MainThread]: 
[0m13:48:22.770495 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 13.39 seconds (13.39s).
[0m13:48:22.771388 [debug] [MainThread]: Command end result
[0m13:48:22.801632 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m13:48:22.803672 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m13:48:22.812506 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m13:48:22.813084 [info ] [MainThread]: 
[0m13:48:22.815525 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:48:22.816121 [info ] [MainThread]: 
[0m13:48:22.816755 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:48:22.821239 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 17.976765, "process_in_blocks": "169712", "process_kernel_time": 0.85482, "process_mem_max_rss": "396896", "process_out_blocks": "3352", "process_user_time": 5.507841}
[0m13:48:22.822336 [debug] [MainThread]: Command `dbt run` succeeded at 13:48:22.822176 after 17.98 seconds
[0m13:48:22.825045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e7439be260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e7289519c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e7288ba050>]}
[0m13:48:22.825761 [debug] [MainThread]: Flushing usage events
[0m13:48:22.930853 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:04:38.520972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e3f2e2200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e3e279600>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e3e2795a0>]}


============================== 14:04:38.524584 | a588dd6c-e567-4940-a2a6-31a6b065c84f ==============================
[0m14:04:38.524584 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:04:38.525427 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:04:41.809518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e24238310>]}
[0m14:04:41.892652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e2423acb0>]}
[0m14:04:41.893395 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:04:42.257930 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:04:42.426806 [debug] [MainThread]: Partial parsing enabled: 2 files deleted, 2 files added, 1 files changed.
[0m14:04:42.427614 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/abordagem_repeat_padronizacao_nomes.sql
[0m14:04:42.428155 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/abordagem_repeat_tratamento_duplicatas_cluster.sql
[0m14:04:42.428883 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/schema.yml
[0m14:04:42.429294 [debug] [MainThread]: Partial parsing: deleted file: queries://models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql
[0m14:04:42.429733 [debug] [MainThread]: Partial parsing: deleted file: queries://models/dashboard_arcgis/staging/stg_repeat_names.sql
[0m14:04:42.973731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e23690130>]}
[0m14:04:43.058652 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:04:43.060289 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:04:43.080292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e23507d90>]}
[0m14:04:43.080953 [info ] [MainThread]: Found 3 models, 1 source, 494 macros
[0m14:04:43.081476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e23507e50>]}
[0m14:04:43.083234 [info ] [MainThread]: 
[0m14:04:43.083747 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:04:43.084252 [info ] [MainThread]: 
[0m14:04:43.084962 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:04:43.085962 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:04:43.086505 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:04:43.496033 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:04:43.496700 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:04:43.891947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e23507100>]}
[0m14:04:43.892633 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:04:43.937401 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:04:43.937873 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:04:43.939144 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:04:43.938511 [info ] [Thread-1 (]: 1 of 1 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:04:43.939799 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:04:43.940371 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:04:43.947718 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:04:43.954195 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:04:43.960109 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:04:43.961092 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m14:04:43.961771 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:04:44.030605 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:04:44.046749 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:04:44.047360 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:04:44.047940 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:04:44.048602 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:04:44.075586 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:04:44.086929 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:04:44.089985 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:04:44.138120 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:04:44.180380 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:04:44.739538 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:2a839c16-13a1-4028-9bbe-4bf8999a8ebd&page=queryresults
[0m14:04:55.550483 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a588dd6c-e567-4940-a2a6-31a6b065c84f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e292ce9e0>]}
[0m14:04:55.551421 [info ] [Thread-1 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 11.61s]
[0m14:04:55.552255 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:04:55.553555 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:04:55.596415 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:04:55.596849 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:04:55.597282 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat_tratamento_duplicatas_cluster' was properly closed.
[0m14:04:55.597729 [info ] [MainThread]: 
[0m14:04:55.598276 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 12.51 seconds (12.51s).
[0m14:04:55.599163 [debug] [MainThread]: Command end result
[0m14:04:55.629300 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:04:55.631292 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:04:55.637812 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:04:55.638280 [info ] [MainThread]: 
[0m14:04:55.638917 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:04:55.639390 [info ] [MainThread]: 
[0m14:04:55.639951 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:04:55.640666 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 17.192574, "process_in_blocks": "157392", "process_kernel_time": 0.791372, "process_mem_max_rss": "397888", "process_out_blocks": "3392", "process_user_time": 5.712906}
[0m14:04:55.641269 [debug] [MainThread]: Command `dbt run` succeeded at 14:04:55.641145 after 17.19 seconds
[0m14:04:55.641735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e3f2e2200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e3ef5b7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d8e23692800>]}
[0m14:04:55.642240 [debug] [MainThread]: Flushing usage events
[0m14:04:55.791489 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:12:41.294099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01c3c6260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01b361660>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01b361600>]}


============================== 14:12:41.297619 | 55eea429-c730-4016-a921-9361a2f25c24 ==============================
[0m14:12:41.297619 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:12:41.298388 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:12:44.567225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca001435270>]}
[0m14:12:44.649891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01c223e20>]}
[0m14:12:44.650571 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:12:45.019048 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:12:45.156733 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m14:12:45.157452 [debug] [MainThread]: Partial parsing: added file: queries://models/abordagem.sql
[0m14:12:45.502054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca0007e05e0>]}
[0m14:12:45.590055 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:12:45.591649 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:12:45.611711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca0008470a0>]}
[0m14:12:45.612361 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:12:45.612935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca000847340>]}
[0m14:12:45.615031 [info ] [MainThread]: 
[0m14:12:45.615702 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:12:45.616601 [info ] [MainThread]: 
[0m14:12:45.617361 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:12:45.623314 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:12:45.623866 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:12:46.058978 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:12:46.059541 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:12:46.353841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01b321b10>]}
[0m14:12:46.354421 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:12:46.402196 [debug] [Thread-1 (]: Began running node model.queries.abordagem
[0m14:12:46.403694 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m14:12:46.403143 [info ] [Thread-1 (]: 1 of 2 START sql view model dashboard_arcgis_dev.abordagem ..................... [RUN]
[0m14:12:46.405597 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem)
[0m14:12:46.406287 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem
[0m14:12:46.404563 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:12:46.418080 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m14:12:46.423182 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:12:46.423872 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m14:12:46.424795 [debug] [Thread-1 (]: Began executing node model.queries.abordagem
[0m14:12:46.439394 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:12:46.466310 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:12:46.467190 [debug] [Thread-1 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
  OPTIONS()
  as SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  rj-smas-dev.dashboard_arcgis_dev.abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid;


[0m14:12:46.467880 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m14:12:46.468373 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:12:46.479776 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:12:46.846947 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:12:46.848761 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:12:46.962126 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:92fefe71-d054-4cc4-ac91-e4d43797f4c0&page=queryresults
[0m14:12:46.962892 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:92fefe71-d054-4cc4-ac91-e4d43797f4c0&page=queryresults
[0m14:12:46.974328 [debug] [Thread-1 (]: Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_filtro_emails was not found in location US
  compiled code at target/run/queries/models/abordagem.sql
[0m14:12:46.977358 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca0007a8730>]}
[0m14:12:46.978553 [error] [Thread-1 (]: 1 of 2 ERROR creating sql view model dashboard_arcgis_dev.abordagem ............ [[31mERROR[0m in 0.57s]
[0m14:12:46.979689 [debug] [Thread-1 (]: Finished running node model.queries.abordagem
[0m14:12:46.980322 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:12:46.980947 [debug] [Thread-5 (]: Marking all children of 'model.queries.abordagem' to be skipped because of status 'error'.  Reason: Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_filtro_emails was not found in location US
  compiled code at target/run/queries/models/abordagem.sql.
[0m14:12:46.981559 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem, now model.queries.abordagem_repeat_padronizacao_nomes)
[0m14:12:46.982819 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:12:46.992319 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:12:46.993244 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:12:47.035048 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:12:47.035781 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:12:47.036348 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:12:47.036868 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:12:47.079401 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:12:47.080154 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:12:47.125484 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:12:47.258756 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:1108440b-c01e-444e-ae09-7561f011c14f&page=queryresults
[0m14:12:59.565360 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '55eea429-c730-4016-a921-9361a2f25c24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca00658a9e0>]}
[0m14:12:59.566309 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 13.15s]
[0m14:12:59.567169 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m14:12:59.568554 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:12:59.611329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:12:59.611761 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat_tratamento_duplicatas_cluster' was properly closed.
[0m14:12:59.612219 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:12:59.612680 [info ] [MainThread]: 
[0m14:12:59.613252 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 14.00 seconds (14.00s).
[0m14:12:59.614300 [debug] [MainThread]: Command end result
[0m14:12:59.644275 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:12:59.646290 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:12:59.653343 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:12:59.653796 [info ] [MainThread]: 
[0m14:12:59.654430 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:12:59.654950 [info ] [MainThread]: 
[0m14:12:59.655559 [error] [MainThread]:   Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_filtro_emails was not found in location US
  compiled code at target/run/queries/models/abordagem.sql
[0m14:12:59.656045 [info ] [MainThread]: 
[0m14:12:59.656585 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m14:12:59.657334 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 18.435074, "process_in_blocks": "140272", "process_kernel_time": 0.800442, "process_mem_max_rss": "396576", "process_out_blocks": "3440", "process_user_time": 5.664054}
[0m14:12:59.657931 [debug] [MainThread]: Command `dbt run` failed at 14:12:59.657783 after 18.44 seconds
[0m14:12:59.658416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01c3c6260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca01c03e8f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca000f92c50>]}
[0m14:12:59.658918 [debug] [MainThread]: Flushing usage events
[0m14:12:59.787122 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:28:47.569965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf21be230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf11595a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf1159540>]}


============================== 14:28:47.573820 | 74b91270-01bf-4f01-b388-f714cecc4cec ==============================
[0m14:28:47.573820 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:28:47.574648 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m14:28:50.896819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bd721d300>]}
[0m14:28:50.982082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf1f9e080>]}
[0m14:28:50.983041 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:28:51.341294 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:28:51.470587 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:28:51.471491 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:28:51.514800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bd6be0c70>]}
[0m14:28:51.608421 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:28:51.610362 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:28:51.628588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bd6c2e170>]}
[0m14:28:51.629337 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:28:51.629866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bd6c2e1d0>]}
[0m14:28:51.631738 [info ] [MainThread]: 
[0m14:28:51.632286 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:28:51.632771 [info ] [MainThread]: 
[0m14:28:51.633538 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:28:51.641520 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:28:51.642107 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:28:52.059226 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:28:52.059898 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:28:52.329440 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf1119ae0>]}
[0m14:28:52.330156 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:28:52.376262 [debug] [Thread-1 (]: Began running node model.queries.abordagem
[0m14:28:52.376816 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat
[0m14:28:52.377562 [info ] [Thread-1 (]: 1 of 2 START sql view model dashboard_arcgis_dev.abordagem ..................... [RUN]
[0m14:28:52.378327 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:28:52.379075 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem)
[0m14:28:52.379720 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat'
[0m14:28:52.380287 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem
[0m14:28:52.380805 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat
[0m14:28:52.391349 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:28:52.396413 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:28:52.397359 [debug] [Thread-2 (]: Began executing node model.queries.abordagem_repeat
[0m14:28:52.398134 [debug] [Thread-1 (]: Began executing node model.queries.abordagem
[0m14:28:52.414278 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:28:52.506299 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:28:52.508679 [debug] [Thread-1 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
  OPTIONS()
  as SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  rj-smas-dev.dashboard_arcgis_dev.abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid;


[0m14:28:52.511471 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:28:52.809857 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:28:52.811540 [debug] [Thread-2 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:28:53.031695 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:e27d9f84-4a64-4f19-a43f-c3de46859e15&page=queryresults
[0m14:28:53.032504 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:e27d9f84-4a64-4f19-a43f-c3de46859e15&page=queryresults
[0m14:28:53.035755 [debug] [Thread-1 (]: Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_repeat_tratamento_duplicatas_cluster was not found in location US
  compiled code at target/run/queries/models/abordagem.sql
[0m14:28:53.037723 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf222ec80>]}
[0m14:28:53.038658 [error] [Thread-1 (]: 1 of 2 ERROR creating sql view model dashboard_arcgis_dev.abordagem ............ [[31mERROR[0m in 0.66s]
[0m14:28:53.039572 [debug] [Thread-1 (]: Finished running node model.queries.abordagem
[0m14:28:53.040336 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:28:53.041329 [debug] [Thread-5 (]: Marking all children of 'model.queries.abordagem' to be skipped because of status 'error'.  Reason: Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_repeat_tratamento_duplicatas_cluster was not found in location US
  compiled code at target/run/queries/models/abordagem.sql.
[0m14:28:53.042113 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem, now model.queries.abordagem_repeat_padronizacao_nomes)
[0m14:28:53.043393 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:28:53.049723 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:28:53.050556 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:28:53.094074 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:28:53.095005 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:28:53.095566 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:28:53.096097 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:28:53.134412 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:28:53.135456 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:28:53.184257 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:28:53.218792 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:081e70c2-12d1-41e9-b7ad-6572ae90b89a&page=queryresults
[0m14:29:03.640444 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74b91270-01bf-4f01-b388-f714cecc4cec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bdc42a9e0>]}
[0m14:29:03.641435 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 11.26s]
[0m14:29:03.642299 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat
[0m14:29:03.643608 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:29:03.687244 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:29:03.687879 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat_tratamento_duplicatas_cluster' was properly closed.
[0m14:29:03.688297 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:29:03.688795 [info ] [MainThread]: 
[0m14:29:03.689340 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 12.06 seconds (12.06s).
[0m14:29:03.690423 [debug] [MainThread]: Command end result
[0m14:29:03.721483 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:29:03.723946 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:29:03.734441 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:29:03.735065 [info ] [MainThread]: 
[0m14:29:03.735781 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:29:03.736461 [info ] [MainThread]: 
[0m14:29:03.737212 [error] [MainThread]:   Database Error in model abordagem (models/abordagem.sql)
  Not found: Table rj-smas-dev:dashboard_arcgis_dev.abordagem_repeat_tratamento_duplicatas_cluster was not found in location US
  compiled code at target/run/queries/models/abordagem.sql
[0m14:29:03.737865 [info ] [MainThread]: 
[0m14:29:03.738529 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m14:29:03.739473 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 16.26043, "process_in_blocks": "115984", "process_kernel_time": 0.766834, "process_mem_max_rss": "391172", "process_out_blocks": "2376", "process_user_time": 5.6291}
[0m14:29:03.740417 [debug] [MainThread]: Command `dbt run` failed at 14:29:03.740255 after 16.26 seconds
[0m14:29:03.741199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf21be230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bf1e3b1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bd6e55cf0>]}
[0m14:29:03.741975 [debug] [MainThread]: Flushing usage events
[0m14:29:03.820393 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:31:34.406091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d3839c62c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d382961660>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d382961600>]}


============================== 14:31:34.410317 | fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14 ==============================
[0m14:31:34.410317 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:31:34.411175 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:31:37.611504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d3689599f0>]}
[0m14:31:37.703620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d368a75ea0>]}
[0m14:31:37.704603 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:31:38.082524 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:31:38.214452 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:31:38.215379 [debug] [MainThread]: Partial parsing: updated file: queries://models/abordagem.sql
[0m14:31:38.694192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d367e5bdf0>]}
[0m14:31:38.787938 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:31:38.789795 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:31:38.805533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d367ebccd0>]}
[0m14:31:38.806276 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:31:38.806850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d367ebcd30>]}
[0m14:31:38.808694 [info ] [MainThread]: 
[0m14:31:38.809251 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:31:38.809745 [info ] [MainThread]: 
[0m14:31:38.810495 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:31:38.816886 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:31:38.817520 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:31:39.241398 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:31:39.242080 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:31:39.504083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d382919b70>]}
[0m14:31:39.504792 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:31:39.550056 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:31:39.550620 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:31:39.552047 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:31:39.551340 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:31:39.552708 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:31:39.553304 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:31:39.559104 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:31:39.566186 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:31:39.570776 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:31:39.571894 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m14:31:39.572483 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:31:39.587776 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:31:39.630228 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:31:39.674862 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:31:39.675905 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:31:39.676433 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:31:39.717150 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:31:39.718797 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:31:39.763332 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:31:39.977910 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:31:39.979669 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:31:40.606081 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:a6b83485-d7db-483c-9874-a1053cfff0cc&page=queryresults
[0m14:31:50.186325 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d36dbfe9e0>]}
[0m14:31:50.187339 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 10.63s]
[0m14:31:50.188211 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:31:50.189210 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m14:31:50.189866 [info ] [Thread-2 (]: 2 of 2 START sql view model dashboard_arcgis_dev.abordagem ..................... [RUN]
[0m14:31:50.190536 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_tratamento_duplicatas_cluster, now model.queries.abordagem)
[0m14:31:50.191070 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m14:31:50.198809 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:31:50.199672 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m14:31:50.219980 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:31:50.221145 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */


  create or replace view `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
  OPTIONS()
  as with __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid;


[0m14:31:50.221982 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:31:50.654176 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:2e1cbe2b-9341-4ebb-b650-5180061f1ab2&page=queryresults
[0m14:31:51.020244 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb33ca33-8fb3-4ba1-944c-8e05bbc7cd14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d384ad5ea0>]}
[0m14:31:51.021183 [info ] [Thread-2 (]: 2 of 2 OK created sql view model dashboard_arcgis_dev.abordagem ................ [[32mCREATE VIEW (0 processed)[0m in 0.83s]
[0m14:31:51.022043 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m14:31:51.023422 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:31:51.066199 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:31:51.066779 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:31:51.067252 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m14:31:51.067736 [info ] [MainThread]: 
[0m14:31:51.068299 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 12.26 seconds (12.26s).
[0m14:31:51.069392 [debug] [MainThread]: Command end result
[0m14:31:51.100521 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:31:51.102590 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:31:51.109758 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:31:51.110209 [info ] [MainThread]: 
[0m14:31:51.110862 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:31:51.111336 [info ] [MainThread]: 
[0m14:31:51.111888 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m14:31:51.112626 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 16.779968, "process_in_blocks": "90032", "process_kernel_time": 0.773161, "process_mem_max_rss": "396276", "process_out_blocks": "3512", "process_user_time": 6.000491}
[0m14:31:51.113230 [debug] [MainThread]: Command `dbt run` succeeded at 14:31:51.113106 after 16.78 seconds
[0m14:31:51.113710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d3839c62c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d3689599f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73d38363ca00>]}
[0m14:31:51.114238 [debug] [MainThread]: Flushing usage events
[0m14:31:51.191449 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:33:01.761323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff1403e6290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff13f37d630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff13f37d5d0>]}


============================== 14:33:01.765631 | 8430370d-4295-4dba-98c9-5f3f4b1d5728 ==============================
[0m14:33:01.765631 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:33:01.766393 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'debug': 'False', 'warn_error': 'None', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:33:04.924221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff1253de2f0>]}
[0m14:33:05.009780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff12a666770>]}
[0m14:33:05.010714 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:33:05.379250 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:33:05.511995 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:33:05.512813 [debug] [MainThread]: Partial parsing: updated file: queries://models/abordagem.sql
[0m14:33:05.868757 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff124ce3e50>]}
[0m14:33:05.958462 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:33:05.960447 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:33:05.976855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff124d3e830>]}
[0m14:33:05.977545 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:33:05.978147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff124d3e890>]}
[0m14:33:05.980130 [info ] [MainThread]: 
[0m14:33:05.980696 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:33:05.981249 [info ] [MainThread]: 
[0m14:33:05.982015 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:33:05.988878 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:33:05.991080 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:33:06.432358 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:33:06.433032 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:33:06.687604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff1254493f0>]}
[0m14:33:06.688421 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:33:06.733632 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:33:06.734207 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:33:06.735651 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:33:06.734940 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:33:06.736383 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:33:06.736960 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:33:06.749133 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:33:06.749785 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:33:06.754971 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:33:06.755788 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m14:33:06.756600 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:33:06.826157 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:33:06.833449 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:33:06.834385 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:33:06.876281 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:33:06.879727 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:33:06.921049 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:33:06.922136 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:33:06.966569 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:33:07.222208 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:33:07.224009 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:33:07.691766 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:a6d1152d-31c2-49ab-aebc-b21a18405bc2&page=queryresults
[0m14:33:18.569424 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff12a4869e0>]}
[0m14:33:18.570412 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 11.83s]
[0m14:33:18.571261 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:33:18.572126 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m14:33:18.572936 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m14:33:18.573584 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_tratamento_duplicatas_cluster, now model.queries.abordagem)
[0m14:33:18.574117 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m14:33:18.582066 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:33:18.582899 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m14:33:18.586475 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:33:19.032601 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:33:19.033960 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m14:33:19.497294 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:5705f7ca-59ce-4abd-b1fe-44a208384639&page=queryresults
[0m14:33:56.190976 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:5705f7ca-59ce-4abd-b1fe-44a208384639&page=queryresults
[0m14:33:56.208398 [debug] [Thread-2 (]: Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql
[0m14:33:56.209324 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8430370d-4295-4dba-98c9-5f3f4b1d5728', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff12440fe80>]}
[0m14:33:56.210166 [error] [Thread-2 (]: 2 of 2 ERROR creating sql table model dashboard_arcgis_dev.abordagem ........... [[31mERROR[0m in 37.64s]
[0m14:33:56.211007 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m14:33:56.211691 [debug] [Thread-5 (]: Marking all children of 'model.queries.abordagem' to be skipped because of status 'error'.  Reason: Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql.
[0m14:33:56.213682 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:33:56.257279 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:33:56.258081 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:33:56.258625 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m14:33:56.259662 [info ] [MainThread]: 
[0m14:33:56.260544 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 50.28 seconds (50.28s).
[0m14:33:56.262169 [debug] [MainThread]: Command end result
[0m14:33:56.311385 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:33:56.313984 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:33:56.336590 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:33:56.337338 [info ] [MainThread]: 
[0m14:33:56.339877 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:33:56.340483 [info ] [MainThread]: 
[0m14:33:56.341346 [error] [MainThread]:   Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql
[0m14:33:56.342207 [info ] [MainThread]: 
[0m14:33:56.342960 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m14:33:56.344016 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 54.655895, "process_in_blocks": "72048", "process_kernel_time": 0.780117, "process_mem_max_rss": "397148", "process_out_blocks": "3512", "process_user_time": 5.901325}
[0m14:33:56.345247 [debug] [MainThread]: Command `dbt run` failed at 14:33:56.344610 after 54.66 seconds
[0m14:33:56.345955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff1403e6290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff1410e6770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff14022d540>]}
[0m14:33:56.346642 [debug] [MainThread]: Flushing usage events
[0m14:33:56.489307 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:34:46.163095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbabede200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbaae79600>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbaae795a0>]}


============================== 14:34:46.167280 | d0faf983-faa6-462f-b74c-cadb059c09f2 ==============================
[0m14:34:46.167280 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:34:46.168137 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'debug': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:34:49.260455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db90d94280>]}
[0m14:34:49.344703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db90ecfaf0>]}
[0m14:34:49.345631 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:34:49.737877 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:34:49.913022 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:34:49.913820 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:34:49.963565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db908b0c70>]}
[0m14:34:50.060007 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:34:50.062151 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:34:50.078681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db906fdf30>]}
[0m14:34:50.079441 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:34:50.080069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db906fdf90>]}
[0m14:34:50.081953 [info ] [MainThread]: 
[0m14:34:50.082505 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:34:50.083032 [info ] [MainThread]: 
[0m14:34:50.083774 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:34:50.090768 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:34:50.091479 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:34:50.529967 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:34:50.530620 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:34:50.808009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbaaddb8e0>]}
[0m14:34:50.808735 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:34:50.862189 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:34:50.863087 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:34:50.865194 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:34:50.865906 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:34:50.864140 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:34:50.881379 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:34:50.881951 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:34:50.882746 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:34:50.883343 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:34:50.888646 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:34:50.931416 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:34:50.932206 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m14:34:50.949209 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:34:50.952240 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:34:50.952879 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:34:50.953558 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:34:51.052992 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:34:51.054759 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:34:51.106559 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:34:51.323909 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:34:51.325646 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:34:51.770963 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:25f4af39-9ad6-49f7-828e-d7d01bae84ec&page=queryresults
[0m14:35:03.829778 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db960f29e0>]}
[0m14:35:03.831011 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.1k rows, 315.1 MiB processed)[0m in 12.95s]
[0m14:35:03.832798 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:35:03.834290 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m14:35:03.835221 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m14:35:03.839905 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_tratamento_duplicatas_cluster, now model.queries.abordagem)
[0m14:35:03.840937 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m14:35:03.862231 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:35:03.864011 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m14:35:03.871289 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:35:03.875855 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m14:35:03.879145 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:35:04.488887 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:4c0fce44-e596-4ab2-aa14-24008e991996&page=queryresults
[0m14:35:47.251603 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:4c0fce44-e596-4ab2-aa14-24008e991996&page=queryresults
[0m14:35:47.255723 [debug] [Thread-2 (]: Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql
[0m14:35:47.256446 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0faf983-faa6-462f-b74c-cadb059c09f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db8dbca710>]}
[0m14:35:47.257257 [error] [Thread-2 (]: 2 of 2 ERROR creating sql table model dashboard_arcgis_dev.abordagem ........... [[31mERROR[0m in 43.42s]
[0m14:35:47.258137 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m14:35:47.259449 [debug] [Thread-5 (]: Marking all children of 'model.queries.abordagem' to be skipped because of status 'error'.  Reason: Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql.
[0m14:35:47.261788 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:35:47.305366 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:35:47.305969 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:35:47.306453 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m14:35:47.307021 [info ] [MainThread]: 
[0m14:35:47.307554 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 57.22 seconds (57.22s).
[0m14:35:47.308635 [debug] [MainThread]: Command end result
[0m14:35:47.342320 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:35:47.344274 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:35:47.351846 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:35:47.352396 [info ] [MainThread]: 
[0m14:35:47.353097 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:35:47.353683 [info ] [MainThread]: 
[0m14:35:47.354394 [error] [MainThread]:   Database Error in model abordagem (models/abordagem.sql)
  Access Denied: BigQuery BigQuery: Permission denied while getting Drive credentials.
  compiled code at target/run/queries/models/abordagem.sql
[0m14:35:47.354950 [info ] [MainThread]: 
[0m14:35:47.355543 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m14:35:47.356371 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 61.272923, "process_in_blocks": "58792", "process_kernel_time": 0.734013, "process_mem_max_rss": "391096", "process_out_blocks": "2464", "process_user_time": 5.735849}
[0m14:35:47.357020 [debug] [MainThread]: Command `dbt run` failed at 14:35:47.356886 after 61.27 seconds
[0m14:35:47.357548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbabede200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71db90d33790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71dbac9972e0>]}
[0m14:35:47.358128 [debug] [MainThread]: Flushing usage events
[0m14:35:47.474561 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:37:53.814972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5debbe290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5ddb59630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5ddb595d0>]}


============================== 14:37:53.819295 | 1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9 ==============================
[0m14:37:53.819295 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:37:53.820041 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:37:56.877487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c3a92410>]}
[0m14:37:56.961363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c3b9bd00>]}
[0m14:37:56.962257 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:37:57.318767 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:37:57.451415 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:37:57.451974 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:37:57.494672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c35a8cd0>]}
[0m14:37:57.589547 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:37:57.591500 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:37:57.607303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c35f6200>]}
[0m14:37:57.608025 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:37:57.608591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c35f6260>]}
[0m14:37:57.610476 [info ] [MainThread]: 
[0m14:37:57.611015 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:37:57.611504 [info ] [MainThread]: 
[0m14:37:57.612249 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:37:57.618480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:37:57.619066 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:37:58.006912 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:37:58.007558 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:37:58.303136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5ddb19b40>]}
[0m14:37:58.303846 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:37:58.348773 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:37:58.349450 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:37:58.350076 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.abordagem_repeat ............. [RUN]
[0m14:37:58.350894 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:37:58.351446 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:37:58.351998 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:37:58.352511 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:37:58.366354 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:37:58.371137 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:37:58.372137 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:37:58.424020 [debug] [Thread-1 (]: Began executing node model.queries.abordagem_repeat
[0m14:37:58.432015 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:37:58.454367 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:37:58.455219 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:37:58.498769 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:37:58.502641 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:37:58.544995 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:37:58.546407 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:37:58.588915 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:37:58.799466 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.abordagem_repeat"
[0m14:37:58.801729 [debug] [Thread-1 (]: On model.queries.abordagem_repeat: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem_repeat"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat`
      
    
    

    OPTIONS()
    as (
      SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
    );
  
[0m14:37:59.199270 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:4d3128ef-a407-492e-b1b4-d90c82d49a05&page=queryresults
[0m14:38:09.214095 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c8dee9e0>]}
[0m14:38:09.215104 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.abordagem_repeat ........ [[32mCREATE TABLE (266.2k rows, 315.2 MiB processed)[0m in 10.86s]
[0m14:38:09.215996 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:38:09.216849 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m14:38:09.217613 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m14:38:09.218276 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_tratamento_duplicatas_cluster, now model.queries.abordagem)
[0m14:38:09.218779 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m14:38:09.226866 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:38:09.227691 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m14:38:09.231615 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:38:09.232742 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem_repeat` as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m14:38:09.233640 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:38:09.743256 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:58d15111-23e7-467a-b359-f174d1d3aaf6&page=queryresults
[0m14:38:58.433394 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e1c6bcb-dad4-4ed4-9312-5930fe4c98f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5dfd0bb50>]}
[0m14:38:58.434354 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis_dev.abordagem ............... [[32mCREATE TABLE (266.2k rows, 353.8 MiB processed)[0m in 49.22s]
[0m14:38:58.435190 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m14:38:58.436518 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:38:58.478939 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:38:58.479478 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat' was properly closed.
[0m14:38:58.479935 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m14:38:58.480462 [info ] [MainThread]: 
[0m14:38:58.480999 [info ] [MainThread]: Finished running 2 table models in 0 hours 1 minutes and 0.87 seconds (60.87s).
[0m14:38:58.482063 [debug] [MainThread]: Command end result
[0m14:38:58.512915 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:38:58.515280 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:38:58.522427 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:38:58.522906 [info ] [MainThread]: 
[0m14:38:58.523562 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:38:58.524063 [info ] [MainThread]: 
[0m14:38:58.524610 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m14:38:58.525387 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 64.78463, "process_in_blocks": "41856", "process_kernel_time": 0.754322, "process_mem_max_rss": "390800", "process_out_blocks": "2464", "process_user_time": 5.428322}
[0m14:38:58.525971 [debug] [MainThread]: Command `dbt run` succeeded at 14:38:58.525853 after 64.79 seconds
[0m14:38:58.526457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5debbe290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5c3a92410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bd5df6d7820>]}
[0m14:38:58.526969 [debug] [MainThread]: Flushing usage events
[0m14:38:58.633377 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:44:06.813110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cbb7e61a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cba829540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cba8294e0>]}


============================== 14:44:06.816259 | 37af5c6b-57e0-4501-9183-cff7fa0001ea ==============================
[0m14:44:06.816259 [info ] [MainThread]: Running with dbt=1.9.4
[0m14:44:06.817124 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/workspaces/pipeline_arcgis/queries', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/workspaces/pipeline_arcgis/queries/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:44:09.840799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cbce4cfd0>]}
[0m14:44:09.943262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cba7de470>]}
[0m14:44:09.944179 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m14:44:10.305186 [debug] [MainThread]: checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c, vars: {}, profile: , target: , version: 1.9.4
[0m14:44:10.436436 [debug] [MainThread]: Partial parsing enabled: 2 files deleted, 2 files added, 0 files changed.
[0m14:44:10.437209 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/abordagem_repeat.sql
[0m14:44:10.437688 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/abordagem.sql
[0m14:44:10.438130 [debug] [MainThread]: Partial parsing: deleted file: queries://models/dashboard_arcgis/abordagem_repeat.sql
[0m14:44:10.438548 [debug] [MainThread]: Partial parsing: deleted file: queries://models/abordagem.sql
[0m14:44:10.788571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca00385b0>]}
[0m14:44:10.878621 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:44:10.880508 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:44:10.896051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca009efb0>]}
[0m14:44:10.896708 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m14:44:10.897276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca009f010>]}
[0m14:44:10.899120 [info ] [MainThread]: 
[0m14:44:10.899651 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:44:10.900175 [info ] [MainThread]: 
[0m14:44:10.900921 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:44:10.901995 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m14:44:10.902533 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:44:11.346464 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m14:44:11.347132 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:44:11.665963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca009c2b0>]}
[0m14:44:11.666652 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:44:11.712009 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m14:44:11.712659 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:44:11.713226 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m14:44:11.713927 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m14:44:11.714458 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m14:44:11.715013 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:44:11.726342 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m14:44:11.730760 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m14:44:11.731958 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:44:11.732489 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m14:44:11.774681 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m14:44:11.817495 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m14:44:11.818564 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:44:11.819150 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m14:44:11.819663 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:44:11.857471 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m14:44:11.858454 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:44:11.904465 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m14:44:11.906074 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m14:44:11.907005 [info ] [Thread-2 (]: 1 of 1 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m14:44:11.908394 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem)
[0m14:44:11.909219 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m14:44:11.922902 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m14:44:11.924411 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m14:44:11.982250 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m14:44:11.984956 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat as (


SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),  __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  __dbt__cte__abordagem_repeat as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m14:44:11.987128 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m14:44:12.859712 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:1095568f-8729-4bc6-9866-cfb1d1875fa3&page=queryresults
[0m14:45:05.912949 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37af5c6b-57e0-4501-9183-cff7fa0001ea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca0031b70>]}
[0m14:45:05.913948 [info ] [Thread-2 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.abordagem ............... [[32mCREATE TABLE (266.2k rows, 315.2 MiB processed)[0m in 54.00s]
[0m14:45:05.914769 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m14:45:05.916102 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:45:05.959468 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:45:05.960151 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat_tratamento_duplicatas_cluster' was properly closed.
[0m14:45:05.960562 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m14:45:05.961061 [info ] [MainThread]: 
[0m14:45:05.961582 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 55.06 seconds (55.06s).
[0m14:45:05.962507 [debug] [MainThread]: Command end result
[0m14:45:05.993868 [debug] [MainThread]: Wrote artifact WritableManifest to /workspaces/pipeline_arcgis/queries/target/manifest.json
[0m14:45:05.996266 [debug] [MainThread]: Wrote artifact SemanticManifest to /workspaces/pipeline_arcgis/queries/target/semantic_manifest.json
[0m14:45:06.003305 [debug] [MainThread]: Wrote artifact RunExecutionResult to /workspaces/pipeline_arcgis/queries/target/run_results.json
[0m14:45:06.003789 [info ] [MainThread]: 
[0m14:45:06.004447 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:45:06.004940 [info ] [MainThread]: 
[0m14:45:06.005478 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:45:06.006225 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 59.26654, "process_in_blocks": "0", "process_kernel_time": 0.704497, "process_mem_max_rss": "395976", "process_out_blocks": "3608", "process_user_time": 5.77169}
[0m14:45:06.006800 [debug] [MainThread]: Command `dbt run` succeeded at 14:45:06.006679 after 59.27 seconds
[0m14:45:06.007305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cbb7e61a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766cba7de470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x766ca01f7d30>]}
[0m14:45:06.007801 [debug] [MainThread]: Flushing usage events
[0m14:45:06.133254 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:20:16.714513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d08c8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d08fd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d08db10>]}


============================== 23:20:16.720154 | 02454d34-dab1-4c61-a076-7b4e63ced89f ==============================
[0m23:20:16.720154 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:20:16.720961 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/root/pipelines/arcgis/queries/logs', 'profiles_dir': '/root/pipelines/arcgis/queries', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --project-dir /root/pipelines/arcgis/queries', 'send_anonymous_usage_stats': 'True'}
[0m23:20:22.383143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14de2f290>]}
[0m23:20:22.492136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16fa8bf50>]}
[0m23:20:22.493104 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:20:22.671529 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m23:20:22.774047 [info ] [MainThread]: Unable to do partial parsing because config vars, config profile, or config target have changed
[0m23:20:22.774659 [debug] [MainThread]: previous checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, current checksum: b5597158181700c50f5bc1c71fe28b37a6fb85633dc5323885263678b6bc782c
[0m23:20:22.775122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14dcb2390>]}
[0m23:20:24.510544 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'abordagem_ficha' in the 'models' section of file 'models/dashboard_arcgis/schema.yml'
[0m23:20:24.747371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14dc6a510>]}
[0m23:20:24.832518 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:20:24.837791 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:20:24.862562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14cddded0>]}
[0m23:20:24.863344 [info ] [MainThread]: Found 4 models, 1 source, 494 macros
[0m23:20:24.863867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14cedad50>]}
[0m23:20:24.866521 [info ] [MainThread]: 
[0m23:20:24.867058 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:20:24.867382 [info ] [MainThread]: 
[0m23:20:24.868037 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:20:24.869206 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m23:20:24.869692 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:20:25.684190 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m23:20:25.685318 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:20:26.261492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14dc70b90>]}
[0m23:20:26.262143 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:20:26.312685 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m23:20:26.313264 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:20:26.314006 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m23:20:26.314935 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m23:20:26.315469 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m23:20:26.316117 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:20:26.327985 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m23:20:26.334949 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m23:20:26.337054 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:20:26.381021 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m23:20:26.382271 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m23:20:26.448547 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:20:26.449956 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:20:26.451138 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m23:20:26.451687 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:20:26.487176 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m23:20:26.488512 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:20:26.537398 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:20:26.538981 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m23:20:26.540278 [info ] [Thread-2 (]: 1 of 1 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m23:20:26.541355 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem)
[0m23:20:26.542028 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m23:20:26.551884 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m23:20:26.553181 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m23:20:26.570552 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m23:20:27.412110 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m23:20:27.415689 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat as (


SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),  __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  __dbt__cte__abordagem_repeat as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis_dev.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m23:20:28.071666 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:c5f08bcb-7e09-47aa-9aaa-f2a3de43114b&page=queryresults
[0m23:21:20.725939 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '02454d34-dab1-4c61-a076-7b4e63ced89f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc14c29b850>]}
[0m23:21:20.727423 [info ] [Thread-2 (]: 1 of 1 OK created sql table model dashboard_arcgis_dev.abordagem ............... [[32mCREATE TABLE (267.6k rows, 316.9 MiB processed)[0m in 54.18s]
[0m23:21:20.728410 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m23:21:20.730291 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:20.780570 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:20.781061 [debug] [MainThread]: Connection 'model.queries.abordagem_repeat_tratamento_duplicatas_cluster' was properly closed.
[0m23:21:20.781348 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m23:21:20.781683 [info ] [MainThread]: 
[0m23:21:20.782035 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 55.91 seconds (55.91s).
[0m23:21:20.782703 [debug] [MainThread]: Command end result
[0m23:21:20.814914 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:21:20.817448 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:21:20.825490 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/queries/target/run_results.json
[0m23:21:20.826142 [info ] [MainThread]: 
[0m23:21:20.826770 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:20.827233 [info ] [MainThread]: 
[0m23:21:20.827735 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m23:21:20.828547 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 64.18611, "process_in_blocks": "371768", "process_kernel_time": 1.475541, "process_mem_max_rss": "429444", "process_out_blocks": "3608", "process_user_time": 7.929843}
[0m23:21:20.829191 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:20.829051 after 64.19 seconds
[0m23:21:20.829748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d0f4590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d0f65d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc16d0f46d0>]}
[0m23:21:20.830316 [debug] [MainThread]: Flushing usage events
[0m23:21:21.425214 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:04:47.536518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf55888290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf55888310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf55889810>]}


============================== 23:04:47.542659 | c6388770-8dc6-446c-bfca-f2a99ade26d4 ==============================
[0m23:04:47.542659 [info ] [MainThread]: Running with dbt=1.9.4
[0m23:04:47.543437 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/root/pipelines/arcgis/pipelines/../queries/logs', 'debug': 'False', 'profiles_dir': '/root/pipelines/arcgis/queries', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --project-dir /root/pipelines/arcgis/pipelines/../queries', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:04:52.437010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf365cb710>]}
[0m23:04:52.515437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf581eb690>]}
[0m23:04:52.516310 [info ] [MainThread]: Registered adapter: bigquery=1.9.2
[0m23:04:52.716798 [debug] [MainThread]: checksum: 53ed91fada2233efb98368d1716b44ab532c83a9c293cf1890b7905d5b45fb25, vars: {}, profile: , target: dev, version: 1.9.4
[0m23:04:52.904454 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 4 files added, 2 files changed.
[0m23:04:52.905208 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/gestao_vagas.sql
[0m23:04:52.905593 [debug] [MainThread]: Partial parsing: added file: queries://macros/padronizacao_nomes.sql
[0m23:04:52.905976 [debug] [MainThread]: Partial parsing: added file: queries://models/dashboard_arcgis/staging/gestao_vagas_repeat.sql
[0m23:04:52.906529 [debug] [MainThread]: Partial parsing: added file: queries://macros/tratamento_duplicatas_cluster.sql
[0m23:04:52.907584 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/schema.yml
[0m23:04:52.908154 [debug] [MainThread]: Partial parsing: updated file: queries://models/dashboard_arcgis/abordagem.sql
[0m23:04:53.656383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf36416810>]}
[0m23:04:53.739530 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:04:53.742371 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:04:53.769290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf35f8c810>]}
[0m23:04:53.769987 [info ] [MainThread]: Found 6 models, 2 sources, 496 macros
[0m23:04:53.770473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf35fd75d0>]}
[0m23:04:53.772657 [info ] [MainThread]: 
[0m23:04:53.773240 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:04:53.773774 [info ] [MainThread]: 
[0m23:04:53.774543 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:04:53.779533 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_rj-smas-dev'
[0m23:04:53.780355 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:04:54.713086 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_rj-smas-dev, now list_rj-smas-dev_dashboard_arcgis_dev)
[0m23:04:54.713821 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:04:55.464462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf559afbd0>]}
[0m23:04:55.465116 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:04:55.527856 [debug] [Thread-1 (]: Began running node model.queries.abordagem_repeat
[0m23:04:55.528707 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:04:55.529619 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_rj-smas-dev_dashboard_arcgis_dev, now model.queries.abordagem_repeat)
[0m23:04:55.530513 [debug] [Thread-2 (]: Acquiring new bigquery connection 'model.queries.abordagem_repeat_padronizacao_nomes'
[0m23:04:55.531131 [debug] [Thread-1 (]: Began compiling node model.queries.abordagem_repeat
[0m23:04:55.531758 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:04:55.543466 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.abordagem_repeat"
[0m23:04:55.548489 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_padronizacao_nomes"
[0m23:04:55.552059 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:55.605938 [debug] [Thread-1 (]: Finished running node model.queries.abordagem_repeat
[0m23:04:55.606593 [debug] [Thread-1 (]: Began running node model.queries.gestao_vagas_repeat
[0m23:04:55.607284 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat, now model.queries.gestao_vagas_repeat)
[0m23:04:55.607733 [debug] [Thread-1 (]: Began compiling node model.queries.gestao_vagas_repeat
[0m23:04:55.608421 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m23:04:55.612507 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.gestao_vagas_repeat"
[0m23:04:55.666471 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_padronizacao_nomes
[0m23:04:55.667384 [debug] [Thread-2 (]: Began running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:04:55.667855 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_padronizacao_nomes, now model.queries.abordagem_repeat_tratamento_duplicatas_cluster)
[0m23:04:55.668250 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:04:55.668755 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:55.734721 [debug] [Thread-1 (]: Finished running node model.queries.gestao_vagas_repeat
[0m23:04:55.753070 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem_repeat_tratamento_duplicatas_cluster"
[0m23:04:55.753793 [debug] [Thread-1 (]: Began running node model.queries.gestao_vagas
[0m23:04:55.754741 [info ] [Thread-1 (]: 1 of 2 START sql table model dashboard_arcgis_dev.gestao_vagas ................. [RUN]
[0m23:04:55.755349 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.queries.gestao_vagas_repeat, now model.queries.gestao_vagas)
[0m23:04:55.755869 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m23:04:55.756328 [debug] [Thread-1 (]: Began compiling node model.queries.gestao_vagas
[0m23:04:55.824494 [debug] [Thread-2 (]: Finished running node model.queries.abordagem_repeat_tratamento_duplicatas_cluster
[0m23:04:55.860775 [debug] [Thread-1 (]: Writing injected SQL for node "model.queries.gestao_vagas"
[0m23:04:55.861759 [debug] [Thread-2 (]: Began running node model.queries.abordagem
[0m23:04:55.863648 [info ] [Thread-2 (]: 2 of 2 START sql table model dashboard_arcgis_dev.abordagem .................... [RUN]
[0m23:04:55.864382 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.queries.abordagem_repeat_tratamento_duplicatas_cluster, now model.queries.abordagem)
[0m23:04:55.865020 [debug] [Thread-1 (]: Began executing node model.queries.gestao_vagas
[0m23:04:55.865770 [debug] [Thread-2 (]: Began compiling node model.queries.abordagem
[0m23:04:55.881931 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:55.890524 [debug] [Thread-2 (]: Writing injected SQL for node "model.queries.abordagem"
[0m23:04:55.938893 [debug] [Thread-2 (]: Began executing node model.queries.abordagem
[0m23:04:55.943042 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m23:04:56.603912 [debug] [Thread-2 (]: Writing runtime sql for node "model.queries.abordagem"
[0m23:04:56.607144 [debug] [Thread-2 (]: On model.queries.abordagem: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.abordagem"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`abordagem`
      
    
    

    OPTIONS()
    as (
      

with __dbt__cte__abordagem_repeat as (


SELECT
  objectid,
  globalid,
  CASE
   WHEN repeat_unidade_calculo = 'CREAS MARIA LINA DE CASTRO LIMA' THEN 'Creas Maria Lina De Castro Lima'
   WHEN repeat_unidade_calculo = 'CREAS SIMONE DE BEAUVOIR' THEN 'Creas Simone De Beauvoir'
   WHEN repeat_unidade_calculo = 'CREAS ARLINDO RODRIGUES' THEN 'Creas Arlindo Rodrigues'
   WHEN repeat_unidade_calculo = 'CREAS JANETE CLAIR' THEN 'Creas Janete Clair'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA ALDAIZA SPOSATI' THEN 'Creas Professora Aldaiza Sposati'
   WHEN repeat_unidade_calculo = 'CREAS PROFESSORA MÁRCIA LOPES' THEN 'Creas Professora Marcia Lopes'
   WHEN repeat_unidade_calculo = 'CREAS STELLA MARIS' THEN 'Creas Stella Maris'
   WHEN repeat_unidade_calculo = 'CREAS NELSON CARNEIRO' THEN 'Creas Nelson Carneiro'
   WHEN repeat_unidade_calculo = 'CREAS WANDA ENGEL ADUAN' THEN 'Creas Wanda Engel Aduan'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO HÉLIO FERNANDES VIEITES' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN repeat_unidade_calculo = 'CREAS DANIELA PEREZ' THEN 'Creas Daniela Perez'
   WHEN repeat_unidade_calculo = 'CREAS PADRE GUILHERME DECAMINADA' THEN 'Creas Padre Guilherme Decaminada'
   WHEN repeat_unidade_calculo = 'CREAS ZILDA ARNS NEUMANN' THEN 'Creas Zilda Arns Neumann'
   WHEN repeat_unidade_calculo = 'CREAS JOÃO MANUEL MONTEIRO' THEN 'Creas Joao Manuel Monteiro'
    WHEN repeat_unidade_calculo = 'CENTRO POP JOSÉ SARAMAGO' THEN 'Centro Pop José Saramago'
   WHEN repeat_unidade_calculo = 'CENTRO POP BÁRBARA CALAZANS' THEN 'Centro Pop Barbara  Calazans'
   ELSE repeat_unidade_calculo
   END AS repeat_unidade_calculo_tratada,
  repeat_unidade_cas,
  repeat_nome_usuario,
  repeat_cpf,

  SAFE.PARSE_DATE('%d/%m/%Y', repeat_data_nascimento) AS repeat_data_nascimento,
  repeat_data_nascimento_iso,
  repeat_grupo_familiar,

  repeat_idade,
  repeat_faixa_etaria,
  CASE
   WHEN repeat_estado_nascimento = 'rio_de_janeiro' THEN 'Rio de Janeiro'
   WHEN repeat_estado_nascimento = 'outros_estados' THEN 'Outros Estados'
   WHEN repeat_estado_nascimento = 'outro_pais' THEN 'Outro País'
   WHEN repeat_estado_nascimento = 'ns_nr' THEN 'NS/NR'
   ELSE repeat_estado_nascimento
   END AS repeat_estado_nascimento_tratada,
  repeat_nome_mae,
  repeat_nome_pai,
  CASE 
   WHEN repeat_raca_cor_etnia = 'parda' THEN 'Parda'
   WHEN repeat_raca_cor_etnia = 'branca' THEN 'Branca'
   WHEN repeat_raca_cor_etnia = 'preta' THEN 'Preta'
   WHEN repeat_raca_cor_etnia = 'amarela' THEN 'Amarela'
   WHEN repeat_raca_cor_etnia = 'indígena' THEN 'Indígena'
   WHEN repeat_raca_cor_etnia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_raca_cor_etnia
   END AS repeat_raca_cor_etnia_tratada,
  CASE
   WHEN repeat_sexo = 'masculino' THEN 'Masculino'
   WHEN repeat_sexo = 'feminino' THEN 'Feminino'
   WHEN repeat_sexo = 'intersexo' THEN 'Intersexo'
   WHEN repeat_sexo = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   ELSE repeat_sexo
   END AS repeat_sexo,
  turno_abordagem,

  DATE(data_abordagem) AS data_abordagem,
  ano_num_data_abordagem,
  dia_num_data_abordagem,
  CASE
  WHEN RIGHT(mes_abrev_data_abordagem, 1) = '.' THEN mes_abrev_data_abordagem
  ELSE CONCAT(mes_abrev_data_abordagem, '.')
  END AS mes_abrev_data_abordagem,

  ano_mes_data_abordagem,
  bairro_abord,

  CONCAT(y, ', ', x) AS coordenadas,

  CASE
   WHEN note_creas = 'CREAS Janete Clair' THEN 'Creas Janete Clair'
   WHEN note_creas = 'CREAS Maria Lina de Castro Lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN note_creas = 'CREAS Daniela Perez' THEN 'Creas Daniela Perez'
   WHEN note_creas = 'CREAS Stella Maris' THEN 'Creas Stella Maris'
   WHEN note_creas = 'CREAS Nélson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS Padre Guilherme Decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN note_creas = 'CREAS Professora Márcia Lopes' THEN 'Creas Professora Márcia Lopes'
   WHEN note_creas = 'CREAS Professora Aldaíza Sposati' THEN 'Creas Professora Aldaíza Sposati'
   WHEN note_creas = 'CREAS João Hélio Fernandes Vieites' THEN 'Creas João Hélio Fernandes Vieites'
   WHEN note_creas = 'CREAS Wanda Engel Aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN note_creas = 'CREAS Zilda Arns Neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN note_creas = 'CREAS Nelson Carneiro' THEN 'Creas Nelson Carneiro'
   WHEN note_creas = 'CREAS João Manoel Monteiro' THEN 'Creas João Manoel Monteiro'
   WHEN note_creas = 'CREAS Simone de Beauvoir' THEN 'Creas Simone de Beauvoir'
   WHEN note_creas = 'CREAS Arlindo Rodrigues' THEN 'Creas Arlindo Rodrigues'
   ELSE note_creas
   END AS note_creas_tratada,
  CASE
   WHEN resp_abordagem = 'cgppsr' THEN 'CTPR'
   WHEN resp_abordagem = 'creas' THEN 'CREAS'
   WHEN resp_abordagem = 'centro_pop' THEN 'CENTRO POP'
   ELSE resp_abordagem
   END AS resp_abordagem,
  CASE resp_abordagem1
   WHEN 'ouvidoria1' THEN 'Ouvidoria CTPR'
   WHEN'ouvidoria2' THEN 'Ouvidoria CREAS'
   WHEN'ouvidoria3' THEN 'Ouvidoria Centro POP'
   WHEN'tenda_acol_direitos' THEN 'Tenda acolhe com direitos'
   WHEN'abord_itinerante' THEN 'Abordagem CTPR'
   WHEN'deman_emergencial1' THEN 'Demanda emergencial CTPR'
   WHEN'naas' THEN 'NAAS'
   WHEN'itinerante' THEN 'Abordagem CREAS'
   WHEN'deman_emergencial2' THEN 'Demanda emergencial CREAS'
   WHEN'abordagem_social' THEN 'Abordagem Centro POP'
   WHEN'demanda_emergencial' THEN 'Demanda emergencial Centro POP'
   WHEN'ncp' THEN 'NCP'
   ELSE resp_abordagem1
   END AS resp_abordagem1,
  acao_conjunta,
  CASE
   WHEN permanencia_rua = 'h24' THEN '24 horas'
   WHEN permanencia_rua = 'apenas_durante_dia' THEN 'Apenas durante o dia'
   WHEN permanencia_rua = 'durante_semana_retorna_casa_final_de_semana' THEN 'Durante a semana'
   WHEN permanencia_rua = 'frequenta_cenas_de_uso_esporadicamente' THEN 'Frequenta cenas de uso'
   WHEN permanencia_rua = 'apenas_durante_noite' THEN 'Apenas durante a noite'
   WHEN permanencia_rua = 'nao_sabe_nao_respondeu' THEN 'NS/NR'
   ELSE permanencia_rua
   END AS permanencia_rua_tratada,
  CASE
   WHEN tempo_permanencia = 'de_1_a_3_anos' THEN 'De 1 a 3 anos'
   WHEN tempo_permanencia = 'de_3_a_6_anos' THEN 'De 3 a 6 anos'
   WHEN tempo_permanencia = 'de_1_a_3_meses' THEN 'De 1 a 3 meses'
   WHEN tempo_permanencia = 'menos_3_dias' THEN 'Menos de 3 dias'
   WHEN tempo_permanencia = 'de_6_meses_a_1_ano' THEN 'De 6 meses a 1 ano'
   WHEN tempo_permanencia = 'de_6_a_10_anos' THEN 'De 6 a 10 anos'
   WHEN tempo_permanencia = 'de_3_a_6_meses' THEN 'De 3 a 6 meses'
   WHEN tempo_permanencia = 'mais_de_10_anos' THEN 'Mais de 10 anos'
   WHEN tempo_permanencia = 'de_7_a_30_dias' THEN 'De 7 a 30 anos'
   WHEN tempo_permanencia = 'de_3_a_7_dias' THEN 'De 3 a 7 dias'
   WHEN tempo_permanencia = 'ns_nr' THEN 'NS/NR'
   ELSE tempo_permanencia
   END AS tempo_permanencia_tratada,
  principal_motivo_permanencia,

  flag_conflito_familiar,
  flag_abandono_familiar,
  flag_desocupacao,
  flag_orfandade,
  flag_acesso_a_renda,
  flag_desemprego,
  flag_desemprego_dos_pais,
  flag_transtorno_psiquiatrico,
  flag_uso_drogas_ilicitas,
  flag_trabalho_infantil,
  flag_exploracao_sexual,
  flag_egresso_sistema_prisional,
  flag_alcoolismo_motivo,
  flag_violencia_conflito_comuni,
  flag_preferencia_vontade_prop,
  flag_egresso_mse,
  flag_imigrante,
  flag_migrante,
  flag_refugiado,
  flag_ns_nr_motivo,
  e_migrante,
  CASE
   WHEN migrante_terra_natal = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
   WHEN migrante_terra_natal = 'sim' THEN 'Sim'
   WHEN migrante_terra_natal = 'nao' THEN 'Não'
   ELSE migrante_terra_natal
   END AS migrante_terra_natal_tratada,
  CASE
   WHEN possui_referencia = 'nao_sabe_nao_quis_responder' THEN 'NS/NR'
    WHEN possui_referencia = 'sim' THEN 'Sim'
    WHEN possui_referencia = 'nao' THEN 'Não'
   ELSE possui_referencia
   END AS possui_referencia_tratada,
  possui_documento,
  documentacao,

  flg_documentacao_identidade,
  flg_documentacao_cnh,
  flg_documentacao_registro_nasc,
  flg_documentacao_ctps,
  flg_documentacao_cpf,
  flg_documentacao_passaporte,
  CASE
   WHEN escolaridade = 'medio_incompleto' THEN 'Médio incompleto'
   WHEN escolaridade = 'fundamental_incompleto' THEN 'Fundamental incompleto'
   WHEN escolaridade = 'medio_completo' THEN 'Médio completo'
   WHEN escolaridade = 'fundamental_completo' THEN 'Fundamental completo'
   WHEN escolaridade = 'nao_alfabetizado' THEN 'Não alfabetizado'
   WHEN escolaridade = 'nao_sabe_nao_respondeu' THEN 'Não sabe/Não respondeu'
   WHEN escolaridade = 'superior_completo' THEN 'Superior completo'
   WHEN escolaridade = 'superior_incompleto' THEN 'Superior incompleto'
   WHEN escolaridade = 'nao_escolarizado' THEN 'Não escolarizado'
   ELSE escolaridade
   END AS escolaridade_tratada,
  recebe_beneficio,
  beneficios,

  flag_bolsa_familia,
  flag_bpc,
  flag_seguro_desemprego,
  flag_aposentadoria,
  flag_pensionista,
  flag_outros_ben,
  beneficios_outros,
  CASE
   WHEN ocupacao = 'catador' THEN 'Catador'
   WHEN ocupacao = 'pedinte' THEN 'Pedinte'
   WHEN ocupacao = 'ambulante' THEN 'Ambulante'
   WHEN ocupacao = 'bicos' THEN 'Bicos'
   WHEN ocupacao = 'outros' THEN 'Outros'
   WHEN ocupacao = 'impossibilitado_para_trabalho' THEN 'Impossibilitado'
   WHEN ocupacao = 'prostituicao' THEN 'Prostituição'
   WHEN ocupacao = 'ns_nr' THEN 'NS/NR' 
   ELSE ocupacao
   END AS ocupacao_tratada,

  flag_nao_tem_interesse,
  flag_gastronomia,
  flag_beleza,
  flag_pequenos_reparos,
  flag_jardinagem,
  flag_empreendedorismo,
  flag_producao_artesanal,
  flag_inclusao_digital,
  flag_outros_curso,
  flag_curso_ns_nr,
  flag_nao_tem,

  flag_alcoolismo,
  flag_asma_bronquite,
  flag_covid_19,
  flag_cancer_tumores,
  flag_diabetes,
  flag_dengue,
  flag_depen_quimica,
  flag_epilepsia,
  flag_escabiose,
  flag_hanseniase,
  flag_hepatite,
  flag_hipertensao_doenca_cardio,
  flag_hiv_aids,
  flag_pneumonia,
  flag_sarampo,
  flag_sifilis,
  flag_transtorno_mental,
  flag_trauma_fisico,
  flag_tuberculose,
  flag_ns_nr,

  CASE
   WHEN aceita_acolhimento IS NULL THEN 'nao'
   WHEN TRIM(LOWER(aceita_acolhimento)) = 'n/a' THEN 'nao'
   ELSE aceita_acolhimento
   END AS aceita_acolhimento_tratada,
  motivo_acolhimento_nao,
  outro_motivo,

  flag_motivo_renda,
  flag_motivo_regra,
  flag_motivo_moradia,
  flag_motivo_animal,
  flag_motivo_n_interesse,
  flag_motivo_outro,
  CASE
   WHEN unidade_destino = 'albergue' THEN 'Albergue'
   WHEN unidade_destino = 'central_recepcao' THEN 'Central de Recepção'
   WHEN unidade_destino = 'outros' THEN 'Outros'
   WHEN unidade_destino = 'com_terapeutica' THEN 'Comunidade Terapêutica'
   WHEN unidade_destino = 'urs' THEN 'URS'
   ELSE unidade_destino
   END AS unidade_destino_tratada,
  CASE equipamento_destino
    WHEN 'albergue_dercy_gonçalves' THEN 'Albergue Dercy Gonçalves'
    WHEN 'albergue_nise_da_silveira' THEN 'Albergue Nise da Silveira'
    WHEN 'craf_tom_jobim' THEN 'Craf Tom Jobim'
    WHEN 'assoc_maranatha_rj_madureira' THEN 'Associação Maranatha RJ Madureira'
    WHEN 'albergue_martin_luther_kingjr' THEN 'Albergue Martin Luther King Jr'
    WHEN 'assoc_maranatha_rj_lins_de_vasconcelos' THEN 'Associação Maranatha RJ Lins de Vasconcelos'
    WHEN 'inst_social_marca_de_cristo' THEN 'Instituto Social Marca de Cristo'
    WHEN 'urs_rio_acolhedor_paciencia' THEN 'Urs Rio Acolhedor Paciência'
    WHEN 'cri_pastor_carlos_portela' THEN 'Cri Pastor Carlos Portela'
    WHEN 'urs_haroldo_costa' THEN 'Urs Haroldo Costa'
    WHEN 'albergue_mais_tempo_lgbtqia' THEN 'Albergue Mais Tempo LGBTQIA'
    WHEN 'assoc_maranatha_rj_padre_miguel' THEN 'Associação Maranatha RJ Padre Miguel'
    WHEN 'assoc_maranatha_rj_vila_kennedy' THEN 'Associação Maranatha RJ Vila Kennedy'
    WHEN 'albergue_betinho' THEN 'Albergue Betinho'
    WHEN 'inst_revivendo_com_cristo' THEN 'Instituto Revivendo com Cristo'
    WHEN 'crca_ademar_ferreira_de_oliveira' THEN 'CRCA Ademar Ferreira de Oliveira'
    WHEN 'assoc_maranatha_rj_bangu' THEN 'Associação Maranatha RJ Bangu'
    WHEN 'crca_taiguara' THEN 'CRCA Taiguara'
    WHEN 'assoc_maranatha_rj_sepetiba' THEN 'Associação Maranatha RJ Sepetiba'
    WHEN 'albergue_alfonso_lavalle' THEN 'Albergue Alfonso Lavalle'
    WHEN 'assoc_maranatha_rj_vila_valqueire' THEN 'Associação Maranatha RJ Vila Valqueire'
    WHEN 'assoc_de_assistencia_social_videira' THEN 'Associação de Assistência Social Videira'
    WHEN 'projeto_alcançando_vidas' THEN 'Projeto Alcançando Vidas'
    WHEN 'camor' THEN 'CAMOR'
    WHEN 'assoc_maranatha_rj_engenho_de_dentro' THEN 'Associação Maranatha RJ Engenho de Dentro'
    WHEN 'inst_social_manasses_campo_grande2' THEN 'Instituto Social Manassés Campo Grande 2'
    WHEN 'inst_social_manasses_campo_grande1' THEN 'Instituto Social Manassés Campo Grande 1'
    WHEN 'comt_valentes_de_davi_escola_de_profetas' THEN 'COMT Valentes de Davi Escola de Profetas'
   ELSE equipamento_destino
   END AS equipamento_destino_tratada,
  CASE
   WHEN encam_creas = 'creas_maria_lina_de_castro_lima' THEN 'Creas Maria Lina De Castro Lima'
   WHEN encam_creas = 'creas_simone_de_beauvoir' THEN 'Creas Simone De Beauvoir'
   WHEN encam_creas = 'creas_arlindo_rodrigues' THEN 'Creas Arlindo Rodrigues'
   WHEN encam_creas = 'creas_janete_clair' THEN 'Creas Janete Clair'
   WHEN encam_creas = 'creas_professora_aldaiza_sposati' THEN 'Creas Professora Aldaiza Sposati'
   WHEN encam_creas = 'creas_professora_marcia_lopes' THEN 'Creas Professora Marcia Lopes'
   WHEN encam_creas = 'creas_stella_maris' THEN 'Creas Stella Maris'
   WHEN encam_creas = 'creas_nelson_carneiro' THEN 'Creas Nelson Carneiro'
   WHEN encam_creas = 'creas_wanda_engel_aduan' THEN 'Creas Wanda Engel Aduan'
   WHEN encam_creas = 'creas_joao_helio_fernandes_vieites' THEN 'Creas Joao Helio Fernandes Vieites'
   WHEN encam_creas = 'creas_daniela_perez' THEN 'Creas Daniela Perez'
   WHEN encam_creas = 'creas_padre_guilherme_decaminada' THEN 'Creas Padre Guilherme Decaminada'
   WHEN encam_creas = 'creas_zilda_arns_neumann' THEN 'Creas Zilda Arns Neumann'
   WHEN encam_creas = 'creas_joao_manuel_monteiro' THEN 'Creas Joao Manuel Monteiro'
   ELSE encam_creas
   END AS encam_creas_tratada,
  CASE
   WHEN encam_centropop = 'centro_pop_jose_saramago' THEN 'Centro Pop José Saramago'
   WHEN encam_centropop = 'centro_pop_barbara_calazans' THEN 'Centro Pop Barbara  Calazans'
   ELSE encam_centropop
   END AS encam_centropop_tratada,
  encam_cras,

  encaminhamento_rede,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT

        CASE
          WHEN LOWER(TRIM(part)) = 'cras' THEN 'CRAS'
          WHEN LOWER(TRIM(part)) = 'defensoria_publica' THEN 'Defensoria Pública'
          WHEN LOWER(TRIM(part)) = 'fundacao_leaoxii' THEN 'Fundação Leão XIII'
          WHEN LOWER(TRIM(part)) = 'outros' THEN 'Outros'
          WHEN LOWER(TRIM(part)) = 'creas' THEN 'CREAS'
          WHEN LOWER(TRIM(part)) = 'conselho_tutelar' THEN 'Conselho Tutelar'
          WHEN LOWER(TRIM(part)) = 'detran' THEN 'DETRAN'
          WHEN LOWER(TRIM(part)) = 'receita_federal' THEN 'Receita Federal'
          WHEN LOWER(TRIM(part)) = 'centro_pop' THEN 'Centro POP'
          WHEN LOWER(TRIM(part)) = 'encaminhamento_de_saude' THEN 'Encaminhamento de Saúde'
          WHEN LOWER(TRIM(part)) = 'cartorio' THEN 'Cartório'
          WHEN LOWER(TRIM(part)) = 'delegacia' THEN 'Delegacia'
          WHEN LOWER(TRIM(part)) = 'nao_houve_encaminhamento' THEN 'Sem encaminhamentos'
          ELSE encaminhamento_rede
        END
      FROM UNNEST(SPLIT(encaminhamento_rede, ',')) AS part
    ),
    ', '
  ) AS encaminhamento_rede_tratada,

  flg_sem_encaminhamento,
  flg_encam_creas,
  flg_encam_centropop,
  flg_encam_cras,
  flg_encam_conselhotutelar,
  flg_encam_encaminhamento_saude,
  flg_encam_defensoria_publica,
  flg_encam_detran,
  flg_encam_cartorio,
  flg_encam_fundacao_leaoxiii,
  flg_encam_receita_federal,
  flg_encam_delegacia,
  flg_encam_outros,
  parentrowid,
  created_user

 FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),  __dbt__cte__abordagem_repeat_padronizacao_nomes as (


WITH base AS (
  SELECT
    globalid,
    parentrowid,
    repeat_nome_usuario,
    repeat_nome_mae,
    ano_num_data_abordagem
  FROM `rj-smas-dev`.`arcgis_raw`.`abordagem_repeat_raw`
),

tokens AS (
  SELECT
    *,

    -- explode em palavras já normalizadas
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ')     AS arr_usuario,
    SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ')     AS arr_mae
  FROM base
),

filtered AS (
  SELECT
    *,

    -- remove stop-words simples
    ARRAY(
      SELECT t
      FROM UNNEST(arr_usuario) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_usuario_ok,

    ARRAY(
      SELECT t
      FROM UNNEST(arr_mae) t
      WHERE t NOT IN ('de','da','do','das','dos','e','a','o','os','as')
    ) AS arr_mae_ok
  FROM tokens
)

SELECT
  globalid,
  parentrowid,
  repeat_nome_usuario,
  repeat_nome_mae,
  ano_num_data_abordagem,

  ARRAY_TO_STRING(arr_usuario_ok, ' ')  AS nome_usuario_norm,
  ARRAY_TO_STRING(arr_mae_ok,     ' ')  AS nome_mae_norm
FROM filtered
),  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as (


-- 1. Base com nomes normalizados
WITH base AS (
    SELECT
        globalid,
        parentrowid,
        nome_usuario_norm AS nm,
        nome_mae_norm     AS mm,
        ano_num_data_abordagem
    FROM __dbt__cte__abordagem_repeat_padronizacao_nomes
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_a AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nm), '_',
          SOUNDEX(SPLIT(mm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY parentrowid) <= 2000
),

pairs_b AS (
    SELECT
        a.parentrowid AS id_a,
        b.parentrowid AS id_b,
        a.nm, a.mm,
        b.nm AS nm_b, b.mm AS mm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.parentrowid < b.parentrowid
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nm,  nm_b) AS d_nm,
        EDIT_DISTANCE(mm,  mm_b) AS d_mm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nm,  ' ')),
              ARRAY_LENGTH(SPLIT(nm_b,' '))
          )                                   AS cont_nm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(mm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(mm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(mm,  ' ')),
              ARRAY_LENGTH(SPLIT(mm_b,' '))
          )                                   AS cont_mm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nm <= 2 OR cont_nm >= 0.8)
      AND (d_mm <= 2 OR cont_mm >= 0.8)
),

-- 7. Grafo não-direcionado (componentes conexas) ····························
graph AS (
    SELECT parentrowid, parentrowid AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT
        parentrowid,
        MIN(neigh) AS cluster_seed          
    FROM graph
    GROUP BY parentrowid                   
),

-- 8. Resultado final (uma linha por parentrowid) ····························
final AS (
    SELECT
        b.globalid,
        b.parentrowid,
        b.nm,
        b.mm,
        b.ano_num_data_abordagem,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (parentrowid)
)

SELECT
    globalid,
    parentrowid,
    nm,
    mm,
    ano_num_data_abordagem,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
) SELECT
  r.*,
  e.cas,
  e.e_mail,
  c.nm,
  c.mm,
  c.cluster_id,
  c.cluster_size,
  c.is_duplicado  
FROM 
  __dbt__cte__abordagem_repeat as r
LEFT JOIN 
  `rj-smas-dev.dashboard_arcgis.abordagem_filtro_emails` as e
ON
  r.repeat_unidade_cas = e.cas
LEFT JOIN  
  __dbt__cte__abordagem_repeat_tratamento_duplicatas_cluster as c
ON
  r.globalid = c.globalid
    );
  
[0m23:04:56.627658 [debug] [Thread-1 (]: Writing runtime sql for node "model.queries.gestao_vagas"
[0m23:04:56.628821 [debug] [Thread-1 (]: On model.queries.gestao_vagas: /* {"app": "dbt", "dbt_version": "1.9.4", "profile_name": "rj_smas_dev", "target_name": "dev", "node_id": "model.queries.gestao_vagas"} */

  
    

    create or replace table `rj-smas-dev`.`dashboard_arcgis_dev`.`gestao_vagas`
      
    
    

    OPTIONS()
    as (
      

WITH  __dbt__cte__gestao_vagas_repeat as (


SELECT * FROM `rj-smas-dev`.`arcgis_raw`.`gestao_vagas_repeat_raw`
), clusters AS (
    -- 1) padroniza nomes -----------------------------------------------------
WITH base_padronizada AS (
    WITH src AS (
    SELECT * FROM `rj-smas-dev`.`arcgis_raw`.`gestao_vagas_repeat_raw`
),

tokens AS (
    SELECT
        globalid, parentrowid,
        
        SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(src.repeat_nome_usuario, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
, ' ') AS arr_usuario,
        SPLIT(
    TRIM(                                                         
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          LOWER(
            REGEXP_REPLACE(NORMALIZE(src.repeat_nome_mae, NFD), r'\p{M}', '')  -- remove acentos
          ),
          r'[^a-z\s]', ' '        -- pontuação → espaço
        ),
        r'\s+', ' '               -- espaços duplicados
      )
    )
,     ' ') AS arr_mae
    FROM src
),

filtered AS (
    SELECT
        *,
        ARRAY(
          SELECT w FROM UNNEST(arr_usuario) w
          WHERE w NOT IN UNNEST(ARRAY<STRING>['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'os', 'as'])
        ) AS arr_usuario_ok,
        ARRAY(
          SELECT w FROM UNNEST(arr_mae) w
          WHERE w NOT IN UNNEST(ARRAY<STRING>['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'os', 'as'])
        ) AS arr_mae_ok
    FROM tokens
)

SELECT
    globalid, parentrowid,
    
    ARRAY_TO_STRING(arr_usuario_ok, ' ') AS nome_usuario_norm,
    ARRAY_TO_STRING(arr_mae_ok,     ' ') AS nome_mae_norm
FROM filtered
),

-- 1. Base com nomes normalizados
base AS (
    SELECT
        globalid   AS globalid,
        parentrowid AS id_principal,
        nome_usuario_norm,
        nome_mae_norm
    FROM base_padronizada
),

-- 2. Bloqueio A  (SOUNDEX do nome)  ·········································
blk_a AS (
    SELECT
        *,
        SOUNDEX(nome_usuario_norm) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY id_principal) <= 2000
),

pairs_a AS (
    SELECT
        a.id_principal AS id_a,
        b.id_principal AS id_b,
        a.nome_usuario_norm, a.nome_mae_norm,
        b.nome_usuario_norm AS nome_usuario_norm_b, b.nome_mae_norm AS nome_mae_norm_b
    FROM blk_a a
    JOIN blk_a b USING (blk)
    WHERE a.id_principal < b.id_principal
),

-- 3. Bloqueio B  (SOUNDEX do nome + último sobrenome da mãe) ···············
blk_b AS (
    SELECT
        *,
        CONCAT(
          SOUNDEX(nome_usuario_norm), '_',
          SOUNDEX(SPLIT(nome_mae_norm, ' ')[SAFE_OFFSET(-1)])  -- último token
        ) AS blk
    FROM base
    QUALIFY ROW_NUMBER() OVER (PARTITION BY blk ORDER BY id_principal) <= 2000
),

pairs_b AS (
    SELECT
        a.id_principal AS id_a,
        b.id_principal AS id_b,
        a.nome_usuario_norm, a.nome_mae_norm,
        b.nome_usuario_norm AS nome_usuario_norm_b, b.nome_mae_norm AS nome_mae_norm_b
    FROM blk_b a
    JOIN blk_b b USING (blk)
    WHERE a.id_principal < b.id_principal
),

-- 4. União dos pares candidatos ·············································
pairs AS (
    SELECT * FROM pairs_a
    UNION ALL
    SELECT * FROM pairs_b
),

-- 5. Métricas de distância e contenção ······································
scored AS (
    SELECT
        id_a, id_b,
        EDIT_DISTANCE(nome_usuario_norm,  nome_usuario_norm_b) AS d_nome_usuario_norm,
        EDIT_DISTANCE(nome_mae_norm,  nome_mae_norm_b) AS d_nome_mae_norm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nome_usuario_norm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nome_usuario_norm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nome_usuario_norm,  ' ')),
              ARRAY_LENGTH(SPLIT(nome_usuario_norm_b,' '))
          )                                   AS cont_nome_usuario_norm,

        ARRAY_LENGTH(
          ARRAY(
            SELECT x FROM UNNEST(SPLIT(nome_mae_norm, ' ')) x
            INTERSECT DISTINCT
            SELECT y FROM UNNEST(SPLIT(nome_mae_norm_b,' ')) y
          )
        ) / LEAST(
              ARRAY_LENGTH(SPLIT(nome_mae_norm,  ' ')),
              ARRAY_LENGTH(SPLIT(nome_mae_norm_b,' '))
          )                                   AS cont_nome_mae_norm
    FROM pairs
),

-- 6. Pares que satisfazem a regra de duplicidade ····························
dupes AS (
    SELECT id_a, id_b
    FROM scored
    WHERE (d_nome_usuario_norm <= 2 OR cont_nome_usuario_norm >= 0.8)
      AND (d_nome_mae_norm <= 2 OR cont_nome_mae_norm >= 0.8)
),

-- 7) Grafo não-direcionado (componentes conexas) ----------------------------------------------------
graph AS (
    SELECT id_principal AS node, id_principal AS neigh FROM base
    UNION ALL
    SELECT id_a, id_b FROM dupes
    UNION ALL
    SELECT id_b, id_a FROM dupes
),

seed AS (
    SELECT node AS id_principal, MIN(neigh) AS cluster_seed
    FROM graph
    GROUP BY node
),

-- 8. Resultado final (uma linha por id_principal) ····························
final AS (
    SELECT
        b.globalid,
        b.id_principal,
        b.nome_usuario_norm,
        b.nome_mae_norm,
        MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,
        COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size
    FROM base b
    JOIN seed USING (id_principal)
)

SELECT
    globalid,
    id_principal,
    nome_usuario_norm,
    nome_mae_norm,
    cluster_id,
    cluster_size,
    cluster_size > 1 AS is_duplicado
FROM final
)

SELECT
    r.*,
    c.nome_usuario_norm,
    c.nome_mae_norm,
    c.cluster_id,
    c.cluster_size,
    c.is_duplicado
FROM __dbt__cte__gestao_vagas_repeat  r
LEFT JOIN clusters c
  ON r.globalid = c.globalid
    );
  
[0m23:04:57.347691 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:c26aedd7-17ac-42cf-bda2-ca32c035b288&page=queryresults
[0m23:04:57.367276 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=rj-smas-dev&j=bq:US:d6df3426-0348-401d-9e9f-e07ed8a07dc6&page=queryresults
[0m23:05:18.838531 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf341c2590>]}
[0m23:05:18.839606 [info ] [Thread-1 (]: 1 of 2 OK created sql table model dashboard_arcgis_dev.gestao_vagas ............ [[32mCREATE TABLE (68.0k rows, 42.0 MiB processed)[0m in 23.08s]
[0m23:05:18.840345 [debug] [Thread-1 (]: Finished running node model.queries.gestao_vagas
[0m23:05:53.670068 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6388770-8dc6-446c-bfca-f2a99ade26d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf35f7f190>]}
[0m23:05:53.670985 [info ] [Thread-2 (]: 2 of 2 OK created sql table model dashboard_arcgis_dev.abordagem ............... [[32mCREATE TABLE (300.2k rows, 355.5 MiB processed)[0m in 57.81s]
[0m23:05:53.671620 [debug] [Thread-2 (]: Finished running node model.queries.abordagem
[0m23:05:53.673353 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:05:53.724708 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:05:53.725277 [debug] [MainThread]: Connection 'model.queries.gestao_vagas' was properly closed.
[0m23:05:53.725937 [debug] [MainThread]: Connection 'model.queries.abordagem' was properly closed.
[0m23:05:53.726496 [info ] [MainThread]: 
[0m23:05:53.726973 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 59.95 seconds (59.95s).
[0m23:05:53.727928 [debug] [MainThread]: Command end result
[0m23:05:53.769278 [debug] [MainThread]: Wrote artifact WritableManifest to /root/pipelines/arcgis/queries/target/manifest.json
[0m23:05:53.771827 [debug] [MainThread]: Wrote artifact SemanticManifest to /root/pipelines/arcgis/queries/target/semantic_manifest.json
[0m23:05:53.779223 [debug] [MainThread]: Wrote artifact RunExecutionResult to /root/pipelines/arcgis/queries/target/run_results.json
[0m23:05:53.779688 [info ] [MainThread]: 
[0m23:05:53.780092 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:05:53.780409 [info ] [MainThread]: 
[0m23:05:53.780758 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m23:05:53.781384 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 66.31475, "process_in_blocks": "429160", "process_kernel_time": 1.474099, "process_mem_max_rss": "429044", "process_out_blocks": "3776", "process_user_time": 6.492101}
[0m23:05:53.781839 [debug] [MainThread]: Command `dbt run` succeeded at 23:05:53.781738 after 66.32 seconds
[0m23:05:53.782239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf558f06d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf558f3e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7faf59cd2bd0>]}
[0m23:05:53.782684 [debug] [MainThread]: Flushing usage events
[0m23:05:54.623363 [debug] [MainThread]: An error was encountered while trying to flush usage events
